<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Defense: Crystal Wars</title>
    <style>
        /* ==================== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò ==================== */
        :root {
            --color-primary: #0a0a1a;
            --color-secondary: #1a1a2e;
            --color-accent: #ffd700;
            --color-danger: #ff4444;
            --color-success: #32cd32;
            --color-info: #1e90ff;
            --color-magic: #ba55d3;
            --color-crystal: #00ffff;
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: #f0f0f0;
            overflow-x: hidden;
        }
        
        /* ==================== –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –°–ï–¢–ö–ê ==================== */
        .game-container {
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
            height: 100vh;
            overflow: hidden;
        }
        
        /* ==================== –ó–ê–ì–û–õ–û–í–û–ö ==================== */
        .game-header {
            grid-column: 1 / -1;
            background: linear-gradient(90deg, 
                rgba(139, 69, 19, 0.3) 0%, 
                rgba(178, 34, 34, 0.4) 50%, 
                rgba(184, 134, 11, 0.3) 100%);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .game-title {
            font-size: clamp(2rem, 4vw, 3rem);
            background: linear-gradient(to right, #f0e6d2, #ffd700);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        
        /* ==================== –ë–û–ö–û–í–´–ï –ü–ê–ù–ï–õ–ò ==================== */
        .side-panel {
            background: rgba(30, 30, 40, 0.9);
            border-radius: var(--border-radius);
            padding: 20px;
            overflow-y: auto;
            border: 1px solid rgba(255, 215, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .panel-title {
            font-size: 1.4rem;
            color: var(--color-accent);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        /* ==================== –ö–ê–†–¢–û–ß–ö–ò –ë–ê–®–ï–ù ==================== */
        .tower-card {
            background: rgba(40, 40, 60, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }
        
        .tower-card:hover {
            transform: translateY(-2px);
            border-color: var(--color-accent);
            background: rgba(50, 50, 70, 0.9);
        }
        
        .tower-card.active {
            border-color: var(--color-accent);
            background: rgba(139, 69, 19, 0.3);
        }
        
        /* ==================== –ò–ì–†–û–í–û–ï –ü–û–õ–ï ==================== */
        .game-area {
            position: relative;
            background: 
                linear-gradient(rgba(15, 20, 35, 0.95), rgba(10, 15, 30, 0.98)),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600"><path fill="%23000000" opacity="0.1" d="M400,300 Q500,200 600,300 T800,300 L800,600 L0,600 L0,300 Q100,400 200,300 T400,300 Z"/></svg>');
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        /* ==================== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==================== */
        .stat-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 5px;
            display: block;
        }
        
        .gold { color: var(--color-accent); }
        .crystals { color: var(--color-crystal); }
        .lives { color: var(--color-danger); }
        .wave { color: var(--color-success); }
        
        /* ==================== –ö–ù–û–ü–ö–ò ==================== */
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 10px;
        }
        
        .btn-primary { background: var(--color-success); color: white; }
        .btn-warning { background: var(--color-magic); color: white; }
        .btn-danger { background: var(--color-danger); color: white; }
        
        .btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.2);
        }
        
        /* ==================== –°–û–û–ë–©–ï–ù–ò–Ø ==================== */
        .message-panel {
            background: linear-gradient(90deg, 
                rgba(139, 69, 19, 0.8), 
                rgba(178, 34, 34, 0.8));
            padding: 15px;
            text-align: center;
            border-top: 2px solid rgba(255, 215, 0, 0.5);
        }
        
        /* ==================== –ö–†–ò–°–¢–ê–õ–õ–´ ==================== */
        .crystal {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--color-crystal);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            animation: float 2s ease-in-out infinite;
            filter: drop-shadow(0 0 10px var(--color-crystal));
            cursor: pointer;
            z-index: 100;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(180deg); }
        }
        
        /* ==================== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: rgba(30, 30, 50, 0.95);
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border: 2px solid var(--color-accent);
        }
        
        /* ==================== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ==================== */
        @media (max-width: 1200px) {
            .game-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 400px auto;
                height: auto;
                overflow-y: auto;
            }
            
            .side-panel {
                order: 2;
            }
            
            .game-area {
                order: 1;
            }
        }
        
        @media (max-width: 768px) {
            .game-container {
                padding: 10px;
                gap: 10px;
            }
            
            .stat-display {
                grid-template-columns: 1fr;
            }
        }
        
        /* ==================== –ü–†–û–ì–†–ï–°–° –ë–ê–† ==================== */
        .progress-container {
            margin: 15px 0;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-success), var(--color-crystal));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* ==================== –¢–£–õ–¢–ò–ü–´ ==================== */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            border: 1px solid var(--color-accent);
            max-width: 250px;
        }
    </style>
</head>
<body>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã -->
    <div class="game-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <header class="game-header">
            <h1 class="game-title">TOWER DEFENSE: CRYSTAL WARS</h1>
            <p>–°–æ–±–µ—Ä–∏—Ç–µ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π!</p>
        </header>
        
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ë–∞—à–Ω–∏ -->
        <div class="side-panel left-panel">
            <h2 class="panel-title">üèóÔ∏è –í–´–ë–û–† –ë–ê–®–ù–ò</h2>
            
            <div class="tower-card active" data-type="basic" data-cost="50" data-crystal-cost="5">
                <h3>‚öîÔ∏è –ë–∞–∑–æ–≤–∞—è –±–∞—à–Ω—è</h3>
                <p>–£—Ä–æ–Ω: <strong>15</strong></p>
                <p>–î–∞–ª—å–Ω–æ—Å—Ç—å: <strong>120px</strong></p>
                <p>–¶–µ–Ω–∞: <span class="gold">50 –∑–æ–ª–æ—Ç–∞</span></p>
                <p>–ö—Ä–∏—Å—Ç–∞–ª–ª—ã: <span class="crystals">5</span></p>
            </div>
            
            <div class="tower-card" data-type="sniper" data-cost="120" data-crystal-cost="15">
                <h3>üéØ –°–Ω–∞–π–ø–µ—Ä—Å–∫–∞—è</h3>
                <p>–£—Ä–æ–Ω: <strong>35</strong></p>
                <p>–î–∞–ª—å–Ω–æ—Å—Ç—å: <strong>200px</strong></p>
                <p>–¶–µ–Ω–∞: <span class="gold">120 –∑–æ–ª–æ—Ç–∞</span></p>
                <p>–ö—Ä–∏—Å—Ç–∞–ª–ª—ã: <span class="crystals">15</span></p>
            </div>
            
            <div class="tower-card" data-type="cannon" data-cost="200" data-crystal-cost="30">
                <h3>üí£ –ü—É—à–∫–∞</h3>
                <p>–£—Ä–æ–Ω: <strong>50 (AoE)</strong></p>
                <p>–î–∞–ª—å–Ω–æ—Å—Ç—å: <strong>100px</strong></p>
                <p>–¶–µ–Ω–∞: <span class="gold">200 –∑–æ–ª–æ—Ç–∞</span></p>
                <p>–ö—Ä–∏—Å—Ç–∞–ª–ª—ã: <span class="crystals">30</span></p>
            </div>
            
            <div class="tower-card" data-type="magic" data-cost="150" data-crystal-cost="25">
                <h3>‚ú® –ú–∞–≥–∏—á–µ—Å–∫–∞—è</h3>
                <p>–£—Ä–æ–Ω: <strong>20 (–±—ã—Å—Ç—Ä–æ)</strong></p>
                <p>–î–∞–ª—å–Ω–æ—Å—Ç—å: <strong>150px</strong></p>
                <p>–¶–µ–Ω–∞: <span class="gold">150 –∑–æ–ª–æ—Ç–∞</span></p>
                <p>–ö—Ä–∏—Å—Ç–∞–ª–ª—ã: <span class="crystals">25</span></p>
            </div>
            
            <div class="panel-title" style="margin-top: 30px;">‚ö° –£–õ–£–ß–®–ï–ù–ò–Ø</div>
            <button class="btn btn-warning" id="upgradeDamage">üí• +–£—Ä–æ–Ω (10 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤)</button>
            <button class="btn btn-warning" id="upgradeRange">üéØ +–î–∞–ª—å–Ω–æ—Å—Ç—å (15 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤)</button>
            <button class="btn btn-danger" id="sellTower">üí∞ –ü—Ä–æ–¥–∞—Ç—å –±–∞—à–Ω—é (50%)</button>
        </div>
        
        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å - –ò–≥—Ä–∞ -->
        <div class="game-area">
            <div class="canvas-container">
                <canvas id="gameCanvas"></canvas>
                <!-- –ö—Ä–∏—Å—Ç–∞–ª–ª—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            
            <div class="message-panel">
                <div id="gameMessage">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞—à–Ω—é –∏ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É!</div>
            </div>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="side-panel right-panel">
            <h2 class="panel-title">üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê</h2>
            
            <div class="stat-display">
                <div class="stat-item">
                    <span>üí∞ –ó–æ–ª–æ—Ç–æ:</span>
                    <span class="stat-value gold" id="goldCount">100</span>
                </div>
                <div class="stat-item">
                    <span>üíé –ö—Ä–∏—Å—Ç–∞–ª–ª—ã:</span>
                    <span class="stat-value crystals" id="crystalCount">20</span>
                </div>
                <div class="stat-item">
                    <span>‚ù§Ô∏è –ñ–∏–∑–Ω–∏:</span>
                    <span class="stat-value lives" id="livesCount">20</span>
                </div>
                <div class="stat-item">
                    <span>üåä –í–æ–ª–Ω–∞:</span>
                    <span class="stat-value wave" id="waveCount">1/10</span>
                </div>
            </div>
            
            <div class="progress-container">
                <div>–ü—Ä–æ–≥—Ä–µ—Å—Å –≤–æ–ª–Ω—ã:</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="waveProgress"></div>
                </div>
            </div>
            
            <div class="panel-title">üéÆ –£–ü–†–ê–í–õ–ï–ù–ò–ï</div>
            <button class="btn btn-primary" id="startBtn">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –≤–æ–ª–Ω—É</button>
            <button class="btn" id="pauseBtn">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
            <button class="btn" id="helpBtn">‚ùì –ü–æ–º–æ—â—å</button>
            
            <div class="panel-title" style="margin-top: 30px;">üèÜ –†–ï–ö–û–†–î</div>
            <div class="stat-item">
                <span>–õ—É—á—à–∏–π —Å—á—ë—Ç:</span>
                <span class="stat-value" id="highScore">0</span>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–º–æ—â–∏ -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <h2 style="color: var(--color-accent); margin-bottom: 20px;">‚ùì –ü–æ–º–æ—â—å –ø–æ –∏–≥—Ä–µ</h2>
            <div style="line-height: 1.6;">
                <p><strong>üéØ –¶–µ–ª—å:</strong> –ó–∞—â–∏—Ç–∏—Ç–µ –∑–∞–º–æ–∫ –æ—Ç –≤—Ä–∞–≥–æ–≤ —Å –ø–æ–º–æ—â—å—é –±–∞—à–µ–Ω.</p>
                <p><strong>üí∞ –ó–æ–ª–æ—Ç–æ:</strong> –ü–∞–¥–∞–µ—Ç —Å –≤—Ä–∞–≥–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –±–∞—à–µ–Ω.</p>
                <p><strong>üíé –ö—Ä–∏—Å—Ç–∞–ª–ª—ã:</strong> –†–µ–¥–∫–∏–π —Ä–µ—Å—É—Ä—Å, –ø–∞–¥–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π.</p>
                <p><strong>üèóÔ∏è –ü–æ—Å—Ç—Ä–æ–π–∫–∞:</strong> –í—ã–±–µ—Ä–∏—Ç–µ –±–∞—à–Ω—é ‚Üí –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø–æ–ª–µ.</p>
                <p><strong>‚ö° –£–ª—É—á—à–µ–Ω–∏—è:</strong> –¢—Ä–µ–±—É—é—Ç –∫—Ä–∏—Å—Ç–∞–ª–ª—ã. –£–ª—É—á—à–∞—é—Ç —É—Ä–æ–Ω –∏ –¥–∞–ª—å–Ω–æ—Å—Ç—å.</p>
                <p><strong>üåä –í–æ–ª–Ω—ã:</strong> –ö–∞–∂–¥–∞—è –≤–æ–ª–Ω–∞ —Å–ª–æ–∂–Ω–µ–µ. –í—Å–µ–≥–æ 10 –≤–æ–ª–Ω.</p>
            </div>
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="closeModal('helpModal')">–ü–æ–Ω—è—Ç–Ω–æ!</button>
        </div>
    </div>
    
    <!-- –¢—É–ª—Ç–∏–ø -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        // ==================== –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ö–û–î ====================
        
        // –°–∏–Ω–≥–ª—Ç–æ–Ω GameManager –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
        const GameManager = {
            // –ò–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            state: {
                gold: 100,
                crystals: 20,
                lives: 20,
                wave: 1,
                totalWaves: 10,
                score: 0,
                highScore: localStorage.getItem('tdHighScore') || 0,
                isRunning: false,
                isPaused: false,
                selectedTower: 'basic',
                selectedTowerCost: 50,
                selectedCrystalCost: 5,
                enemiesAlive: 0,
                enemiesKilled: 0,
                gameTime: 0,
                lastCrystalDrop: 0
            },
            
            // –ü—É—Ç—å –≤—Ä–∞–≥–æ–≤ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
            path: Object.freeze([
                {x: -20, y: 200},
                {x: 200, y: 200},
                {x: 200, y: 100},
                {x: 400, y: 100},
                {x: 400, y: 300},
                {x: 600, y: 300},
                {x: 600, y: 150},
                {x: 850, y: 150}
            ]),
            
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∞—à–µ–Ω
            towersConfig: Object.freeze({
                basic: { damage: 15, range: 120, cost: 50, crystalCost: 5, color: '#32CD32', rate: 60 },
                sniper: { damage: 35, range: 200, cost: 120, crystalCost: 15, color: '#1E90FF', rate: 120 },
                cannon: { damage: 50, range: 100, cost: 200, crystalCost: 30, color: '#FF4500', rate: 180 },
                magic: { damage: 20, range: 150, cost: 150, crystalCost: 25, color: '#BA55D3', rate: 30 }
            }),
            
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—Ä–∞–≥–æ–≤
            enemiesConfig: Object.freeze({
                basic: { health: 30, speed: 1.2, gold: 10, crystals: 0.2, color: '#FF6347' },
                fast: { health: 20, speed: 2.0, gold: 15, crystals: 0.3, color: '#00CED1' },
                tank: { health: 100, speed: 0.8, gold: 30, crystals: 0.5, color: '#696969' }
            }),
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            init() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ canvas
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                // –ò–≥—Ä–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã
                this.towers = [];
                this.enemies = [];
                this.projectiles = [];
                this.crystals = [];
                this.particles = [];
                
                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                this.updateUI();
                this.setupEventListeners();
                this.showMessage('–í—ã–±–µ—Ä–∏—Ç–µ –±–∞—à–Ω—é –∏ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É!');
                
                // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
                this.lastTime = 0;
                requestAnimationFrame((time) => this.gameLoop(time));
            },
            
            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ canvas
            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                this.render();
            },
            
            // –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
            gameLoop(currentTime) {
                const deltaTime = currentTime - this.lastTime;
                this.lastTime = currentTime;
                
                if (!this.state.isPaused && this.state.isRunning) {
                    this.state.gameTime += deltaTime;
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    this.update(deltaTime);
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ–ª–Ω—ã
                    if (this.enemies.length === 0 && this.state.enemiesAlive === 0) {
                        this.waveComplete();
                    }
                }
                
                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
                this.render();
                
                // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ü–∏–∫–ª–∞
                requestAnimationFrame((time) => this.gameLoop(time));
            },
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            update(deltaTime) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    if (!this.enemies[i].update(deltaTime)) {
                        this.enemies.splice(i, 1);
                    }
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞—à–µ–Ω
                this.towers.forEach(tower => tower.update());
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω–∞—Ä—è–¥–æ–≤
                for (let i = this.projectiles.length - 1; i >= 0; i--) {
                    if (!this.projectiles[i].update()) {
                        this.projectiles.splice(i, 1);
                    }
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤
                for (let i = this.crystals.length - 1; i >= 0; i--) {
                    if (!this.crystals[i].update()) {
                        this.crystals.splice(i, 1);
                    }
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    if (!this.particles[i].update()) {
                        this.particles.splice(i, 1);
                    }
                }
                
                // –°–ª—É—á–∞–π–Ω–æ–µ –≤—ã–ø–∞–¥–µ–Ω–∏–µ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤
                if (this.state.gameTime - this.state.lastCrystalDrop > 5000 && 
                    Math.random() < 0.001 && this.state.isRunning) {
                    this.dropRandomCrystal();
                    this.state.lastCrystalDrop = this.state.gameTime;
                }
            },
            
            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏–≥—Ä—ã
            render() {
                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;
                
                // –û—á–∏—Å—Ç–∫–∞ canvas
                ctx.clearRect(0, 0, width, height);
                
                // –§–æ–Ω
                ctx.fillStyle = '#0F1525';
                ctx.fillRect(0, 0, width, height);
                
                // –ü—É—Ç—å
                this.drawPath();
                
                // –ó–∞–º–æ–∫
                this.drawCastle();
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
                this.crystals.forEach(crystal => crystal.draw(ctx));
                this.towers.forEach(tower => tower.draw(ctx));
                this.enemies.forEach(enemy => enemy.draw(ctx));
                this.projectiles.forEach(projectile => projectile.draw(ctx));
                this.particles.forEach(particle => particle.draw(ctx));
                
                // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –±–∞—à–Ω–∏
                if (this.hoveredTile) {
                    const config = this.towersConfig[this.state.selectedTower];
                    ctx.strokeStyle = config.color + '80';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(this.hoveredTile.x, this.hoveredTile.y, config.range, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    ctx.fillStyle = config.color + '40';
                    ctx.beginPath();
                    ctx.arc(this.hoveredTile.x, this.hoveredTile.y, 20, 0, Math.PI * 2);
                    ctx.fill();
                }
            },
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—É—Ç–∏
            drawPath() {
                const ctx = this.ctx;
                const scale = this.canvas.width / 900;
                
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 40 * scale;
                ctx.lineCap = 'round';
                ctx.beginPath();
                
                this.path.forEach((point, i) => {
                    const x = point.x * scale;
                    const y = point.y * scale;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                
                ctx.stroke();
            },
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–º–∫–∞
            drawCastle() {
                const ctx = this.ctx;
                const scale = this.canvas.width / 900;
                const lastPoint = this.path[this.path.length - 1];
                const x = lastPoint.x * scale;
                const y = lastPoint.y * scale;
                
                // –û—Å–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–º–∫–∞
                ctx.fillStyle = '#2F4F4F';
                ctx.fillRect(x, y - 40, 50 * scale, 80 * scale);
                
                // –ë–∞—à–Ω–∏
                ctx.fillStyle = '#696969';
                ctx.fillRect(x - 10 * scale, y - 60, 20 * scale, 20 * scale);
                ctx.fillRect(x + 40 * scale, y - 60, 20 * scale, 20 * scale);
                
                // –ö—Ä—ã—à–∏
                ctx.fillStyle = '#8B0000';
                ctx.beginPath();
                ctx.moveTo(x - 15 * scale, y - 60);
                ctx.lineTo(x, y - 80 * scale);
                ctx.lineTo(x + 15 * scale, y - 60);
                ctx.closePath();
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(x + 35 * scale, y - 60);
                ctx.lineTo(x + 50 * scale, y - 80 * scale);
                ctx.lineTo(x + 65 * scale, y - 60);
                ctx.closePath();
                ctx.fill();
            },
            
            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–∞
            dropRandomCrystal() {
                const x = Math.random() * (this.canvas.width - 40) + 20;
                const y = Math.random() * (this.canvas.height - 40) + 20;
                const value = Math.floor(Math.random() * 3) + 1; // 1-3 –∫—Ä–∏—Å—Ç–∞–ª–ª–∞
                
                this.crystals.push(new Crystal(x, y, value));
                this.showMessage('üíé –ö—Ä–∏—Å—Ç–∞–ª–ª –ø–æ—è–≤–∏–ª—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ!');
            },
            
            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ–ª–Ω—ã
            waveComplete() {
                this.state.isRunning = false;
                this.state.wave++;
                
                if (this.state.wave > this.state.totalWaves) {
                    this.victory();
                } else {
                    const reward = this.state.wave * 10;
                    this.state.gold += reward;
                    this.showMessage(`–í–æ–ª–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! +${reward} –∑–æ–ª–æ—Ç–∞`);
                    this.updateUI();
                }
            },
            
            // –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã
            startWave() {
                if (this.state.isRunning) return;
                
                this.state.isRunning = true;
                this.state.enemiesAlive = 5 + this.state.wave * 2;
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
                const enemyTypes = ['basic', 'fast', 'tank'];
                
                for (let i = 0; i < this.state.enemiesAlive; i++) {
                    setTimeout(() => {
                        const type = enemyTypes[Math.min(Math.floor(Math.random() * (this.state.wave / 3)), 2)];
                        this.enemies.push(new Enemy(type, this.state.wave));
                    }, i * 1000);
                }
                
                this.showMessage(`–í–æ–ª–Ω–∞ ${this.state.wave} –Ω–∞—á–∞–ª–∞—Å—å!`);
                this.updateUI();
            },
            
            // –ü–æ–±–µ–¥–∞
            victory() {
                this.state.isRunning = false;
                this.state.score = this.state.gold + this.state.crystals * 10 + this.state.wave * 100;
                
                if (this.state.score > this.state.highScore) {
                    this.state.highScore = this.state.score;
                    localStorage.setItem('tdHighScore', this.state.score);
                }
                
                this.showMessage(`–ü–û–ë–ï–î–ê! –°—á—ë—Ç: ${this.state.score}`);
                this.updateUI();
            },
            
            // –ü–æ—Ä–∞–∂–µ–Ω–∏–µ
            gameOver() {
                this.state.isRunning = false;
                this.showMessage(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –í–æ–ª–Ω–∞: ${this.state.wave}`);
            },
            
            // –ü–æ–∫—É–ø–∫–∞ –±–∞—à–Ω–∏
            buyTower(x, y) {
                if (this.state.gold < this.state.selectedTowerCost || 
                    this.state.crystals < this.state.selectedCrystalCost) {
                    this.showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤!');
                    return false;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –º–µ—Å—Ç–∞
                for (const tower of this.towers) {
                    const dx = tower.x - x;
                    const dy = tower.y - y;
                    if (Math.sqrt(dx * dx + dy * dy) < 40) {
                        this.showMessage('–ú–µ—Å—Ç–æ –∑–∞–Ω—è—Ç–æ!');
                        return false;
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –Ω–∞ –ø—É—Ç–∏
                for (let i = 0; i < this.path.length - 1; i++) {
                    const A = this.path[i];
                    const B = this.path[i + 1];
                    const scale = this.canvas.width / 900;
                    
                    if (this.pointToLineDistance(x, y, A.x * scale, A.y * scale, B.x * scale, B.y * scale) < 50) {
                        this.showMessage('–ù–µ–ª—å–∑—è —Å—Ç—Ä–æ–∏—Ç—å –Ω–∞ –ø—É—Ç–∏!');
                        return false;
                    }
                }
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –±–∞—à–Ω–∏
                this.towers.push(new Tower(x, y, this.state.selectedTower));
                this.state.gold -= this.state.selectedTowerCost;
                this.state.crystals -= this.state.selectedCrystalCost;
                
                // –≠—Ñ—Ñ–µ–∫—Ç —á–∞—Å—Ç–∏—Ü
                for (let i = 0; i < 20; i++) {
                    this.particles.push(new Particle(
                        x, y,
                        this.towersConfig[this.state.selectedTower].color,
                        Math.random() * Math.PI * 2
                    ));
                }
                
                this.showMessage('–ë–∞—à–Ω—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞!');
                this.updateUI();
                return true;
            },
            
            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –¥–æ –ª–∏–Ω–∏–∏
            pointToLineDistance(px, py, x1, y1, x2, y2) {
                const A = px - x1;
                const B = py - y1;
                const C = x2 - x1;
                const D = y2 - y1;
                
                const dot = A * C + B * D;
                const lenSq = C * C + D * D;
                const param = lenSq !== 0 ? dot / lenSq : -1;
                
                let xx, yy;
                
                if (param < 0) {
                    xx = x1;
                    yy = y1;
                } else if (param > 1) {
                    xx = x2;
                    yy = y2;
                } else {
                    xx = x1 + param * C;
                    yy = y1 + param * D;
                }
                
                const dx = px - xx;
                const dy = py - yy;
                return Math.sqrt(dx * dx + dy * dy);
            },
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            updateUI() {
                document.getElementById('goldCount').textContent = Math.floor(this.state.gold);
                document.getElementById('crystalCount').textContent = Math.floor(this.state.crystals);
                document.getElementById('livesCount').textContent = this.state.lives;
                document.getElementById('waveCount').textContent = `${this.state.wave}/${this.state.totalWaves}`;
                document.getElementById('highScore').textContent = this.state.highScore;
                
                const progress = ((5 + this.state.wave * 2 - this.state.enemiesAlive) / (5 + this.state.wave * 2)) * 100;
                document.getElementById('waveProgress').style.width = `${progress}%`;
            },
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            showMessage(text) {
                document.getElementById('gameMessage').textContent = text;
            },
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners() {
                const canvas = this.canvas;
                
                // –ö–ª–∏–∫ –ø–æ canvas
                canvas.addEventListener('click', (e) => {
                    if (!this.state.isRunning) {
                        this.showMessage('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –≤–æ–ª–Ω—É!');
                        return;
                    }
                    
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫—Ä–∏—Å—Ç–∞–ª–ª—É
                    for (let i = this.crystals.length - 1; i >= 0; i--) {
                        if (this.crystals[i].contains(x, y)) {
                            this.state.crystals += this.crystals[i].value;
                            this.crystals.splice(i, 1);
                            this.showMessage(`+${this.crystals[i]?.value || 1} –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!`);
                            this.updateUI();
                            return;
                        }
                    }
                    
                    // –ü–æ–∫—É–ø–∫–∞ –±–∞—à–Ω–∏
                    this.buyTower(x, y);
                });
                
                // –ù–∞–≤–µ–¥–µ–Ω–∏–µ –º—ã—à–∏ –Ω–∞ canvas
                canvas.addEventListener('mousemove', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –Ω–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª
                    for (const crystal of this.crystals) {
                        if (crystal.contains(x, y)) {
                            canvas.style.cursor = 'pointer';
                            this.hoveredTile = null;
                            return;
                        }
                    }
                    
                    canvas.style.cursor = 'crosshair';
                    this.hoveredTile = {x, y};
                });
                
                // –í—ã–±–æ—Ä –±–∞—à–Ω–∏
                document.querySelectorAll('.tower-card').forEach(card => {
                    card.addEventListener('click', () => {
                        document.querySelectorAll('.tower-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        
                        this.state.selectedTower = card.dataset.type;
                        this.state.selectedTowerCost = parseInt(card.dataset.cost);
                        this.state.selectedCrystalCost = parseInt(card.dataset.crystalCost);
                        
                        this.showMessage(`–í—ã–±—Ä–∞–Ω–∞: ${card.querySelector('h3').textContent}`);
                    });
                });
                
                // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                document.getElementById('startBtn').addEventListener('click', () => {
                    if (this.state.isPaused) {
                        this.state.isPaused = false;
                        this.showMessage('–ò–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∞');
                    } else {
                        this.startWave();
                    }
                });
                
                document.getElementById('pauseBtn').addEventListener('click', () => {
                    this.state.isPaused = !this.state.isPaused;
                    this.showMessage(this.state.isPaused ? '–ò–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ' : '–ò–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∞');
                });
                
                document.getElementById('helpBtn').addEventListener('click', () => {
                    document.getElementById('helpModal').style.display = 'flex';
                });
                
                // –ö–Ω–æ–ø–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π
                document.getElementById('upgradeDamage').addEventListener('click', () => {
                    if (this.state.crystals >= 10) {
                        this.state.crystals -= 10;
                        this.towers.forEach(tower => tower.upgradeDamage());
                        this.showMessage('–£—Ä–æ–Ω –≤—Å–µ—Ö –±–∞—à–µ–Ω —É–≤–µ–ª–∏—á–µ–Ω!');
                        this.updateUI();
                    } else {
                        this.showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!');
                    }
                });
                
                document.getElementById('upgradeRange').addEventListener('click', () => {
                    if (this.state.crystals >= 15) {
                        this.state.crystals -= 15;
                        this.towers.forEach(tower => tower.upgradeRange());
                        this.showMessage('–î–∞–ª—å–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –±–∞—à–µ–Ω —É–≤–µ–ª–∏—á–µ–Ω–∞!');
                        this.updateUI();
                    } else {
                        this.showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!');
                    }
                });
                
                // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
                document.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case ' ': this.state.isPaused = !this.state.isPaused; break;
                        case '1': document.querySelector('.tower-card[data-type="basic"]').click(); break;
                        case '2': document.querySelector('.tower-card[data-type="sniper"]').click(); break;
                        case '3': document.querySelector('.tower-card[data-type="cannon"]').click(); break;
                        case '4': document.querySelector('.tower-card[data-type="magic"]').click(); break;
                    }
                });
            }
        };
        
        // ==================== –ö–õ–ê–°–°–´ –ò–ì–†–û–í–´–• –û–ë–™–ï–ö–¢–û–í ====================
        
        class Tower {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.config = GameManager.towersConfig[type];
                this.damage = this.config.damage;
                this.range = this.config.range;
                this.cooldown = 0;
                this.level = 1;
                this.upgradeMultiplier = 1;
            }
            
            update() {
                if (this.cooldown > 0) {
                    this.cooldown--;
                    return;
                }
                
                // –ü–æ–∏—Å–∫ —Ü–µ–ª–∏
                let target = null;
                let minDist = this.range;
                
                for (const enemy of GameManager.enemies) {
                    const dx = enemy.x - this.x;
                    const dy = enemy.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < minDist) {
                        minDist = dist;
                        target = enemy;
                    }
                }
                
                // –ê—Ç–∞–∫–∞
                if (target) {
                    this.shoot(target);
                    this.cooldown = this.config.rate / this.upgradeMultiplier;
                }
            }
            
            shoot(target) {
                GameManager.projectiles.push(new Projectile(this.x, this.y, target, this.damage * this.upgradeMultiplier));
            }
            
            draw(ctx) {
                // –û—Å–Ω–æ–≤–∞–Ω–∏–µ
                ctx.fillStyle = this.config.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // –£—Ä–æ–≤–µ–Ω—å
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.level.toString(), this.x, this.y + 5);
            }
            
            upgradeDamage() {
                this.upgradeMultiplier *= 1.2;
                this.level++;
            }
            
            upgradeRange() {
                this.range *= 1.2;
                this.level++;
            }
        }
        
        class Enemy {
            constructor(type, wave) {
                this.type = type;
                this.config = GameManager.enemiesConfig[type];
                this.pathIndex = 0;
                this.x = GameManager.path[0].x * (GameManager.canvas.width / 900);
                this.y = GameManager.path[0].y * (GameManager.canvas.width / 900);
                this.health = this.config.health * (1 + (wave - 1) * 0.2);
                this.maxHealth = this.health;
                this.speed = this.config.speed;
                this.gold = this.config.gold;
                this.crystalChance = this.config.crystals;
                this.size = 12;
            }
            
            update(deltaTime) {
                // –î–≤–∏–∂–µ–Ω–∏–µ –ø–æ –ø—É—Ç–∏
                if (this.pathIndex >= GameManager.path.length - 1) {
                    GameManager.state.lives--;
                    GameManager.state.enemiesAlive--;
                    if (GameManager.state.lives <= 0) {
                        GameManager.gameOver();
                    }
                    GameManager.updateUI();
                    return false;
                }
                
                const scale = GameManager.canvas.width / 900;
                const target = GameManager.path[this.pathIndex + 1];
                const tx = target.x * scale;
                const ty = target.y * scale;
                
                const dx = tx - this.x;
                const dy = ty - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < this.speed) {
                    this.pathIndex++;
                } else {
                    this.x += (dx / dist) * this.speed;
                    this.y += (dy / dist) * this.speed;
                }
                
                return this.health > 0;
            }
            
            draw(ctx) {
                // –¢–µ–ª–æ
                ctx.fillStyle = this.config.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                
                // –ó–¥–æ—Ä–æ–≤—å–µ
                const healthWidth = 30;
                const healthPercent = this.health / this.maxHealth;
                
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(this.x - healthWidth/2, this.y - 20, healthWidth, 4);
                
                ctx.fillStyle = healthPercent > 0.5 ? '#00FF00' : '#FFA500';
                ctx.fillRect(this.x - healthWidth/2, this.y - 20, healthWidth * healthPercent, 4);
            }
            
            takeDamage(damage) {
                this.health -= damage;
                
                if (this.health <= 0) {
                    this.onDeath();
                    return false;
                }
                return true;
            }
            
            onDeath() {
                // –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ —É–±–∏–π—Å—Ç–≤–æ
                GameManager.state.gold += this.gold;
                GameManager.state.enemiesAlive--;
                GameManager.state.enemiesKilled++;
                
                // –®–∞–Ω—Å –≤—ã–ø–∞–¥–µ–Ω–∏—è –∫—Ä–∏—Å—Ç–∞–ª–ª–∞
                if (Math.random() < this.crystalChance) {
                    GameManager.crystals.push(new Crystal(this.x, this.y, 1));
                }
                
                GameManager.updateUI();
                return false;
            }
        }
        
        class Projectile {
            constructor(x, y, target, damage) {
                this.x = x;
                this.y = y;
                this.target = target;
                this.damage = damage;
                this.speed = 8;
                this.size = 5;
            }
            
            update() {
                if (!this.target || this.target.health <= 0) return false;
                
                const dx = this.target.x - this.x;
                const dy = this.target.y - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < this.speed) {
                    this.target.takeDamage(this.damage);
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ–ø–∞–¥–∞–Ω–∏—è
                    for (let i = 0; i < 5; i++) {
                        GameManager.particles.push(new Particle(
                            this.target.x, this.target.y,
                            '#FFD700',
                            Math.random() * Math.PI * 2
                        ));
                    }
                    
                    return false;
                }
                
                this.x += (dx / dist) * this.speed;
                this.y += (dy / dist) * this.speed;
                return true;
            }
            
            draw(ctx) {
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        class Crystal {
            constructor(x, y, value) {
                this.x = x;
                this.y = y;
                this.value = value;
                this.size = 20;
                this.collected = false;
                this.creationTime = Date.now();
                this.lifespan = 15000; // 15 —Å–µ–∫—É–Ω–¥
                this.pulse = 0;
            }
            
            update() {
                if (Date.now() - this.creationTime > this.lifespan) {
                    return false;
                }
                
                this.pulse = (Math.sin(Date.now() * 0.005) + 1) * 0.2;
                return !this.collected;
            }
            
            draw(ctx) {
                const size = this.size * (1 + this.pulse);
                
                ctx.save();
                ctx.fillStyle = '#00FFFF';
                ctx.shadowColor = '#00FFFF';
                ctx.shadowBlur = 15;
                
                // –§–æ—Ä–º–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–∞
                ctx.beginPath();
                ctx.moveTo(this.x, this.y - size);
                ctx.lineTo(this.x + size * 0.7, this.y - size * 0.3);
                ctx.lineTo(this.x + size * 0.4, this.y + size * 0.8);
                ctx.lineTo(this.x - size * 0.4, this.y + size * 0.8);
                ctx.lineTo(this.x - size * 0.7, this.y - size * 0.3);
                ctx.closePath();
                ctx.fill();
                
                // –ë–ª–µ—Å–∫
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.moveTo(this.x, this.y - size * 0.5);
                ctx.lineTo(this.x + size * 0.2, this.y - size * 0.3);
                ctx.lineTo(this.x, this.y - size * 0.1);
                ctx.closePath();
                ctx.fill();
                
                // –ó–Ω–∞—á–µ–Ω–∏–µ
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.value.toString(), this.x, this.y + size * 1.2);
                
                ctx.restore();
            }
            
            contains(px, py) {
                const dx = px - this.x;
                const dy = py - this.y;
                return Math.sqrt(dx * dx + dy * dy) < this.size;
            }
        }
        
        class Particle {
            constructor(x, y, color, angle) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.angle = angle;
                this.speed = Math.random() * 3 + 1;
                this.life = 30;
                this.size = Math.random() * 3 + 1;
            }
            
            update() {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
                this.life--;
                this.size *= 0.95;
                return this.life > 0 && this.size > 0.1;
            }
            
            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.life / 30;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }
        
        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function showTooltip(text, x, y) {
            const tooltip = document.getElementById('tooltip');
            tooltip.textContent = text;
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
            tooltip.style.opacity = '1';
            
            setTimeout(() => {
                tooltip.style.opacity = '0';
            }, 2000);
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        
        document.addEventListener('DOMContentLoaded', () => {
            GameManager.init();
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // –¢—É–ª—Ç–∏–ø—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –±–∞—à–µ–Ω
            document.querySelectorAll('.tower-card').forEach(card => {
                card.addEventListener('mouseenter', (e) => {
                    const rect = card.getBoundingClientRect();
                    showTooltip('–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞', rect.left, rect.top - 10);
                });
            });
        });
    </script>
</body>
</html>
