<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Defense: Royal Defender</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-bg: linear-gradient(135deg, #0c0c1a 0%, #1a1a2e 100%);
            --gold-color: #ffd700;
            --bronze-color: #cd7f32;
            --silver-color: #c0c0c0;
            --health-color: #ff4444;
            --range-color: #44ff44;
            --speed-color: #4444ff;
            --cost-color: #ffaa00;
            --score-color: #aa44ff;
        }
        
        body {
            min-height: 100vh;
            max-height: 100vh;
            background: var(--primary-bg);
            color: #f0e6d2;
            overflow: hidden;
            position: relative;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
        }
        
        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω —Å —á–∞—Å—Ç–∏—Ü–∞–º–∏ */
        .particles {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            top: 0;
            left: 0;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã */
        .game-container {
            position: relative;
            max-width: 100%;
            height: calc(100vh - 20px);
            margin: 0 auto;
            padding: 10px;
            z-index: 2;
            display: flex;
            flex-direction: column;
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */
        .game-header {
            text-align: center;
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(90deg, 
                rgba(139, 69, 19, 0.3) 0%, 
                rgba(178, 34, 34, 0.4) 50%, 
                rgba(184, 134, 11, 0.3) 100%);
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.5),
                inset 0 0 50px rgba(255, 215, 0, 0.1);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .game-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255, 215, 0, 0.1) 50%, 
                transparent 70%);
            animation: shine 8s infinite linear;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(360deg); }
        }
        
        .game-title {
            font-size: clamp(1.8rem, 4vw, 2.8rem);
            background: linear-gradient(to right, #f0e6d2, #ffd700, #daa520);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px rgba(218, 165, 32, 0.5);
            margin-bottom: 5px;
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
            font-weight: 900;
            line-height: 1.2;
        }
        
        .game-subtitle {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            color: #c9b37e;
            font-style: italic;
            position: relative;
            z-index: 1;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .game-interface {
            display: flex;
            flex: 1;
            gap: 15px;
            min-height: 0;
            height: 100%;
        }
        
        /* –ë–æ–∫–æ–≤—ã–µ –ø–∞–Ω–µ–ª–∏ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π */
        .side-panel {
            background: linear-gradient(145deg, 
                rgba(30, 30, 40, 0.9) 0%, 
                rgba(50, 50, 70, 0.85) 100%);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.4),
                inset 0 0 30px rgba(255, 215, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            min-width: 260px;
            max-width: 260px;
            overflow-y: auto;
        }
        
        .side-panel::-webkit-scrollbar {
            width: 8px;
        }
        
        .side-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        .side-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.5);
            border-radius: 4px;
        }
        
        .side-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 215, 0, 0.7);
        }
        
        .left-panel {
            border-color: #8b4513;
            border-image: linear-gradient(45deg, #8b4513, #daa520) 1;
        }
        
        .right-panel {
            border-color: #b22222;
            border-image: linear-gradient(45deg, #b22222, #ff8c00) 1;
        }
        
        .panel-title {
            font-size: 1.4rem;
            color: #ffd700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(218, 165, 32, 0.5);
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex-shrink: 0;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –±–∞—à–µ–Ω */
        .tower-cards {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .tower-card {
            background: linear-gradient(145deg, 
                rgba(40, 40, 60, 0.8) 0%, 
                rgba(60, 60, 80, 0.9) 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .tower-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            border-color: #ffd700;
        }
        
        .tower-card.active {
            background: linear-gradient(145deg, 
                rgba(139, 69, 19, 0.6) 0%, 
                rgba(178, 34, 34, 0.7) 100%);
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .tower-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            transition: left 0.5s;
        }
        
        .tower-card:hover::before {
            left: 100%;
        }
        
        .tower-name {
            font-size: 1.2rem;
            color: #ffd700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tower-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 10px 0;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .stat-value {
            font-size: 1rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #c9b37e;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */
        .game-button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            user-select: none;
            flex-shrink: 0;
        }
        
        .game-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .game-button:active::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(50, 50);
                opacity: 0;
            }
        }
        
        .btn-primary {
            background: linear-gradient(to bottom, #32CD32, #228B22);
            color: white;
            box-shadow: 0 5px 15px rgba(50, 205, 50, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(to bottom, #3cb371, #2E8B57);
            box-shadow: 0 8px 20px rgba(50, 205, 50, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: linear-gradient(to bottom, #FFA500, #FF8C00);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 165, 0, 0.3);
        }
        
        .btn-warning:hover {
            background: linear-gradient(to bottom, #FFB347, #FF8C00);
            box-shadow: 0 8px 20px rgba(255, 165, 0, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: linear-gradient(to bottom, #1E90FF, #4169E1);
            color: white;
            box-shadow: 0 5px 15px rgba(30, 144, 255, 0.3);
        }
        
        .btn-info:hover {
            background: linear-gradient(to bottom, #63B3ED, #4169E1);
            box-shadow: 0 8px 20px rgba(30, 144, 255, 0.5);
            transform: translateY(-2px);
        }
        
        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
        .game-field {
            flex: 1;
            background: 
                radial-gradient(circle at center, 
                    rgba(20, 25, 45, 0.95) 0%, 
                    rgba(10, 15, 30, 0.98) 100%);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 
                inset 0 0 50px rgba(0, 0, 0, 0.7),
                0 0 40px rgba(139, 69, 19, 0.4);
            border: 3px solid #8b4513;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }
        
        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 0;
        }
        
        #gameCanvas {
            border-radius: 12px;
            box-shadow: 
                0 0 20px rgba(255, 215, 0, 0.3),
                inset 0 0 20px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(218, 165, 32, 0.6);
            background-color: rgba(15, 20, 35, 0.9);
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –ø–æ–¥ –ø–æ–ª–µ–º */
        .game-field-bottom {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
        }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–æ–ª–Ω—ã */
        .wave-progress {
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
            position: relative;
        }
        
        .wave-progress-bar {
            height: 100%;
            background: linear-gradient(to right, #32CD32, #FFD700);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .wave-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.2) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* –ü–∞–Ω–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π */
        .message-panel {
            background: linear-gradient(to right, 
                rgba(139, 69, 19, 0.8), 
                rgba(178, 34, 34, 0.8));
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.5);
            position: relative;
            overflow: hidden;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #gameMessage {
            font-size: 1rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(145deg, 
                rgba(30, 30, 50, 0.95) 0%, 
                rgba(50, 50, 70, 0.95) 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 90vh;
            border: 3px solid #daa520;
            box-shadow: 0 0 50px rgba(218, 165, 32, 0.5);
            position: relative;
            animation: modalAppear 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            color: #ffd700;
            cursor: pointer;
            transition: transform 0.3s;
            z-index: 1001;
        }
        
        .close-modal:hover {
            transform: rotate(90deg);
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ª—É—á—à–µ–Ω–∏—è */
        #upgradeModal .modal-content {
            max-width: 500px;
            text-align: center;
        }
        
        .upgrade-image {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            border: 3px solid #daa520;
        }
        
        .upgrade-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .upgrade-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .upgrade-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .upgrade-stat {
            background: rgba(255, 215, 0, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        /* –õ–æ–≥–æ—Ç–∏–ø */
        .logo-container {
            position: absolute;
            top: 25px;
            right: 25px;
            width: 50px;
            height: 50px;
            z-index: 10;
        }
        
        .game-logo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }
        
        /* –ü–∞–Ω–µ–ª—å —Å –±–∞—à–Ω—è–º–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
        .tower-drag-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .draggable-tower {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
            transition: transform 0.2s;
            user-select: none;
            border: 2px solid transparent;
        }
        
        .draggable-tower:hover {
            transform: scale(1.1);
            border-color: #ffd700;
        }
        
        .draggable-tower:active {
            cursor: grabbing;
            transform: scale(0.95);
        }
        
        .draggable-tower[data-type="basic"] { background: #32CD32; }
        .draggable-tower[data-type="sniper"] { background: #1E90FF; }
        .draggable-tower[data-type="cannon"] { background: #FF4500; }
        .draggable-tower[data-type="magic"] { background: #BA55D3; }
        
        .tower-cost {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ffd700;
            color: #000;
            font-size: 12px;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
        .drag-indicator {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.8;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–π */
        .continue-btn {
            background: linear-gradient(to bottom, #FF4444, #CC0000);
            color: white;
            margin-top: 10px;
        }
        
        .continue-btn:hover {
            background: linear-gradient(to bottom, #FF6666, #FF0000);
            transform: translateY(-2px);
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1200px) {
            .game-interface {
                gap: 10px;
            }
            
            .side-panel {
                min-width: 220px;
                max-width: 220px;
                padding: 12px;
            }
            
            .panel-title {
                font-size: 1.2rem;
            }
            
            .tower-card {
                padding: 12px;
            }
            
            .tower-name {
                font-size: 1.1rem;
            }
            
            .tower-drag-container {
                left: 10px;
                bottom: 10px;
            }
            
            .draggable-tower {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
        }
        
        @media (max-width: 992px) {
            .game-interface {
                flex-direction: column;
                height: auto;
            }
            
            .side-panel {
                min-width: 100%;
                max-width: 100%;
                max-height: 200px;
            }
            
            .left-panel, .right-panel {
                order: 2;
            }
            
            .game-field {
                order: 1;
                min-height: 400px;
            }
            
            .tower-cards {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                overflow-x: auto;
                overflow-y: hidden;
            }
            
            .tower-card {
                margin-bottom: 0;
                min-width: 200px;
            }
            
            .tower-drag-container {
                flex-wrap: wrap;
                max-width: 200px;
            }
        }
        
        @media (max-width: 768px) {
            .game-container {
                padding: 5px;
                height: calc(100vh - 10px);
            }
            
            .game-header {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .game-title {
                font-size: 1.6rem;
            }
            
            .tower-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .game-button {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .logo-container {
                top: 15px;
                right: 15px;
                width: 40px;
                height: 40px;
            }
            
            .tower-drag-container {
                bottom: 5px;
                left: 5px;
                padding: 8px;
                gap: 8px;
            }
            
            .draggable-tower {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }
        
        @media (max-width: 480px) {
            .tower-cards {
                grid-template-columns: 1fr;
            }
            
            .game-button {
                font-size: 0.8rem;
                padding: 8px;
            }
            
            .upgrade-image {
                width: 150px;
                height: 150px;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .tower-drag-container {
                flex-direction: column;
                max-width: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- –õ–æ–≥–æ—Ç–∏–ø -->
    <div class="logo-container">
        <img src="https://w7.pngwing.com/pngs/132/506/png-transparent-toilet-bidet-seats-bathroom-newspaper-graphy-taekwondo-sticker-hand-bathroom-room.png" 
             alt="–õ–æ–≥–æ—Ç–∏–ø" class="game-logo">
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å —Å –±–∞—à–Ω—è–º–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è -->
    <div class="tower-drag-container">
        <div class="draggable-tower" data-type="basic" data-cost="60" draggable="true">
            <span>üèπ</span>
            <div class="tower-cost">60</div>
        </div>
        <div class="draggable-tower" data-type="sniper" data-cost="140" draggable="true">
            <span>üéØ</span>
            <div class="tower-cost">140</div>
        </div>
        <div class="draggable-tower" data-type="cannon" data-cost="220" draggable="true">
            <span>üí£</span>
            <div class="tower-cost">220</div>
        </div>
        <div class="draggable-tower" data-type="magic" data-cost="320" draggable="true">
            <span>üîÆ</span>
            <div class="tower-cost">320</div>
        </div>
    </div>
    
    <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã –Ω–∞ —Ñ–æ–Ω–µ -->
    <div class="particles" id="particles"></div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–º–æ—â–∏ -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('helpModal')">&times;</span>
            <h2 style="color: #ffd700; margin-bottom: 20px; text-align: center;">–ü–æ–º–æ—â—å –ø–æ –∏–≥—Ä–µ</h2>
            <div style="line-height: 1.8;">
                <p><strong>üéØ –¶–µ–ª—å –∏–≥—Ä—ã:</strong> –ó–∞—â–∏—Ç–∏—Ç–µ –∑–∞–º–æ–∫ –æ—Ç –≤—Ä–∞–≥–æ–≤, –ø–æ—Å—Ç—Ä–æ–∏–≤ –∏ —É–ª—É—á—à–∞—è –±–∞—à–Ω–∏.</p>
                <p><strong>üèóÔ∏è –ü–æ—Å—Ç—Ä–æ–π–∫–∞ –±–∞—à–µ–Ω:</strong> –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –±–∞—à–Ω—é —Å–Ω–∏–∑—É —Å–ª–µ–≤–∞ –Ω–∞ –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ.</p>
                <p><strong>‚ö° –£–ª—É—á—à–µ–Ω–∏–µ –±–∞—à–µ–Ω:</strong> –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –±–∞—à–Ω—é –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —É–ª—É—á—à–µ–Ω–∏—è.</p>
                <p><strong>üí∞ –ó–æ–ª–æ—Ç–æ:</strong> –ü–æ–ª—É—á–∞–π—Ç–µ –∑–∞ —É–±–∏–π—Å—Ç–≤–æ –≤—Ä–∞–≥–æ–≤, —Ç—Ä–∞—Ç—å—Ç–µ –Ω–∞ –ø–æ—Å—Ç—Ä–æ–π–∫—É –∏ —É–ª—É—á—à–µ–Ω–∏—è.</p>
                <p><strong>‚ù§Ô∏è –ñ–∏–∑–Ω–∏:</strong> –¢–µ—Ä—è—é—Ç—Å—è –∫–æ–≥–¥–∞ –≤—Ä–∞–≥–∏ –¥–æ—Ö–æ–¥—è—Ç –¥–æ –∑–∞–º–∫–∞. –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.</p>
                <p><strong>üåä –í–æ–ª–Ω—ã:</strong> –ö–∞–∂–¥–∞—è —Å–ª–µ–¥—É—é—â–∞—è –≤–æ–ª–Ω–∞ —Å–ª–æ–∂–Ω–µ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π. –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.</p>
                <p><strong>üèÜ –ü–æ–±–µ–¥–∞:</strong> –ü—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ 15 –≤–æ–ª–Ω —á—Ç–æ–±—ã –ø–æ–±–µ–¥–∏—Ç—å!</p>
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,215,0,0.1); border-radius: 10px;">
                    <strong>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</strong>
                    <div>1-4 - –í—ã–±–æ—Ä –±–∞—à–Ω–∏</div>
                    <div>–ü—Ä–æ–±–µ–ª - –ü–∞—É–∑–∞/–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</div>
                    <div>Enter - –ù–∞—á–∞—Ç—å –≤–æ–ª–Ω—É</div>
                    <div>Escape - –ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–∞</div>
                    <div>R - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∂–∏–∑–Ω–∏ (50 –∑–æ–ª–æ—Ç–∞)</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∫–æ—Ä–¥–æ–≤ -->
    <div id="recordsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('recordsModal')">&times;</span>
            <h2 style="color: #ffd700; margin-bottom: 20px; text-align: center;">–†–µ–∫–æ—Ä–¥—ã</h2>
            <div id="recordsList" style="margin-top: 20px;">
                <!-- –†–µ–∫–æ—Ä–¥—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ª—É—á—à–µ–Ω–∏—è -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('upgradeModal')">&times;</span>
            <h2 style="color: #ffd700; margin-bottom: 20px; text-align: center;">–£–ª—É—á—à–µ–Ω–∏–µ –±–∞—à–Ω–∏</h2>
            
            <div class="upgrade-image">
                <img id="upgradeTowerImage" src="" alt="–£–ª—É—á—à–µ–Ω–Ω–∞—è –±–∞—à–Ω—è">
            </div>
            
            <div class="upgrade-info">
                <h3 id="upgradeTowerName" style="color: #ffd700; margin-bottom: 10px;">–ë–∞—à–Ω—è —É–ª—É—á—à–µ–Ω–∞!</h3>
                <p style="margin-bottom: 15px;">–ë–∞—à–Ω—è –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ —É–ª—É—á—à–µ–Ω–∞ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è!</p>
                
                <div class="upgrade-stats">
                    <div class="upgrade-stat">
                        <div style="color: #44ff44; font-weight: bold;">–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å:</div>
                        <div id="newTowerLevel" style="font-size: 1.5rem; font-weight: bold;">2</div>
                    </div>
                    <div class="upgrade-stat">
                        <div style="color: #ff4444; font-weight: bold;">–£—Ä–æ–Ω:</div>
                        <div id="newDamage" style="font-size: 1.5rem; font-weight: bold;">+25%</div>
                    </div>
                    <div class="upgrade-stat">
                        <div style="color: #4444ff; font-weight: bold;">–°–∫–æ—Ä–æ—Å—Ç—å:</div>
                        <div id="newSpeed" style="font-size: 1.5rem; font-weight: bold;">+10%</div>
                    </div>
                    <div class="upgrade-stat">
                        <div style="color: #ffaa00; font-weight: bold;">–î–∞–ª—å–Ω–æ—Å—Ç—å:</div>
                        <div id="newRange" style="font-size: 1.5rem; font-weight: bold;">+20%</div>
                    </div>
                </div>
                
                <button class="game-button btn-primary" onclick="closeModal('upgradeModal')" style="margin-top: 20px;">
                    <i class="fas fa-check"></i> –ü–û–ù–Ø–¢–ù–û
                </button>
            </div>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã -->
    <div class="game-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <header class="game-header">
            <h1 class="game-title">TOWER DEFENSE: ROYAL DEFENDER</h1>
            <p class="game-subtitle">–ó–∞—â–∏—Ç–∏ –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ –ª—å–≤–∞ –æ—Ç –ø–æ–ª—á–∏—â –≤—Ä–∞–≥–æ–≤!</p>
        </header>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div class="game-interface">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ë–∞—à–Ω–∏ -->
            <div class="side-panel left-panel">
                <h2 class="panel-title">
                    <i class="fas fa-tower-observation"></i> –ë–ê–®–ù–ò
                </h2>
                
                <div class="tower-cards">
                    <div class="tower-card active" data-tower="basic" data-cost="60">
                        <div class="tower-name">
                            <i class="fas fa-bow-arrow"></i> –°—Ç—Ä–µ–ª–∫–æ–≤–∞—è
                        </div>
                        <div class="tower-stats">
                            <div class="stat">
                                <span class="stat-value" style="color: var(--health-color);">15</span>
                                <span class="stat-label">–£—Ä–æ–Ω</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--range-color);">140px</span>
                                <span class="stat-label">–î–∞–ª—å–Ω–æ—Å—Ç—å</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--speed-color);">1.0s</span>
                                <span class="stat-label">–°–∫–æ—Ä–æ—Å—Ç—å</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--cost-color);">60</span>
                                <span class="stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tower-card" data-tower="sniper" data-cost="140">
                        <div class="tower-name">
                            <i class="fas fa-crosshairs"></i> –°–Ω–∞–π–ø–µ—Ä—Å–∫–∞—è
                        </div>
                        <div class="tower-stats">
                            <div class="stat">
                                <span class="stat-value" style="color: var(--health-color);">35</span>
                                <span class="stat-label">–£—Ä–æ–Ω</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--range-color);">220px</span>
                                <span class="stat-label">–î–∞–ª—å–Ω–æ—Å—Ç—å</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--speed-color);">2.0s</span>
                                <span class="stat-label">–°–∫–æ—Ä–æ—Å—Ç—å</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--cost-color);">140</span>
                                <span class="stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tower-card" data-tower="cannon" data-cost="220">
                        <div class="tower-name">
                            <i class="fas fa-explosion"></i> –ü—É—à–∫–∞
                        </div>
                        <div class="tower-stats">
                            <div class="stat">
                                <span class="stat-value" style="color: var(--health-color);">50</span>
                                <span class="stat-label">–£—Ä–æ–Ω</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--range-color);">110px</span>
                                <span class="stat-label">–î–∞–ª—å–Ω–æ—Å—Ç—å</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--speed-color);">2.5s</span>
                                <span class="stat-label">–°–∫–æ—Ä–æ—Å—Ç—å</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--cost-color);">220</span>
                                <span class="stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tower-card" data-tower="magic" data-cost="320">
                        <div class="tower-name">
                            <i class="fas fa-hat-wizard"></i> –ú–∞–≥–∏—á–µ—Å–∫–∞—è
                        </div>
                        <div class="tower-stats">
                            <div class="stat">
                                <span class="stat-value" style="color: var(--health-color);">20</span>
                                <span class="stat-label">–£—Ä–æ–Ω</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--range-color);">160px</span>
                                <span class="stat-label">–î–∞–ª—å–Ω–æ—Å—Ç—å</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--speed-color);">0.5s</span>
                                <span class="stat-label">–°–∫–æ—Ä–æ—Å—Ç—å</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: var(--cost-color);">320</span>
                                <span class="stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="selected-tower-info">
                    <h3 style="color: #ffd700; margin: 15px 0 10px; text-align: center;">
                        <i class="fas fa-info-circle"></i> –ò–ù–§–û–†–ú–ê–¶–ò–Ø
                    </h3>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
                        <p style="margin-bottom: 8px; font-size: 0.9rem;"><strong>–í—ã–±—Ä–∞–Ω–∞:</strong> <span id="selectedTowerName">–°—Ç—Ä–µ–ª–∫–æ–≤–∞—è</span></p>
                        <p style="margin-bottom: 8px; font-size: 0.9rem;"><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> <span id="towerLevel">1</span></p>
                        <p style="margin-bottom: 8px; font-size: 0.9rem;"><strong>–£–ª—É—á—à–µ–Ω–∏–µ:</strong> <span id="upgradeCost">120</span> –∑–æ–ª–æ—Ç–∞</p>
                    </div>
                </div>
            </div>
            
            <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å - –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
            <div class="game-field">
                <div class="canvas-container">
                    <canvas id="gameCanvas" width="800" height="550"></canvas>
                </div>
                
                <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –ø–æ–¥ –ø–æ–ª–µ–º -->
                <div class="game-field-bottom">
                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–æ–ª–Ω—ã -->
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem;">
                            <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –≤–æ–ª–Ω—ã:</span>
                            <span id="waveProgressText">0/0</span>
                        </div>
                        <div class="wave-progress">
                            <div class="wave-progress-bar" id="waveProgressBar"></div>
                        </div>
                    </div>
                    
                    <!-- –ü–∞–Ω–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
                    <div class="message-panel">
                        <div id="gameMessage">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –±–∞—à–Ω—é –Ω–∞ –ø–æ–ª–µ –¥–ª—è –∑–∞—â–∏—Ç—ã!</div>
                    </div>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div class="side-panel right-panel">
                <h2 class="panel-title">
                    <i class="fas fa-chart-line"></i> –°–¢–ê–¢–ò–°–¢–ò–ö–ê
                </h2>
                
                <div class="game-stats" style="flex: 1;">
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span><i class="fas fa-coins" style="color: #ffd700;"></i> –ó–æ–ª–æ—Ç–æ:</span>
                                <span id="goldAmount" style="font-weight: bold; color: #ffd700;">200</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span><i class="fas fa-heart" style="color: #ff4444;"></i> –ñ–∏–∑–Ω–∏:</span>
                                <span id="livesCount" style="font-weight: bold; color: #ff4444;">25</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span><i class="fas fa-wave-square" style="color: #44ff44;"></i> –í–æ–ª–Ω–∞:</span>
                                <span id="waveNumber" style="font-weight: bold; color: #44ff44;">1/15</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span><i class="fas fa-skull-crossbones" style="color: #ffaa00;"></i> –£–±–∏—Ç–æ:</span>
                                <span id="enemiesKilled" style="font-weight: bold; color: #ffaa00;">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span><i class="fas fa-star" style="color: #aa44ff;"></i> –°—á—ë—Ç:</span>
                                <span id="scoreValue" style="font-weight: bold; color: #aa44ff;">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–π -->
                    <button class="game-button continue-btn" id="restoreLivesBtn">
                        <i class="fas fa-heartbeat"></i> –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ –ñ–ò–ó–ù–ò (50 –∑–æ–ª–æ—Ç–∞)
                    </button>
                </div>
                
                <h2 class="panel-title">
                    <i class="fas fa-gamepad"></i> –£–ü–†–ê–í–õ–ï–ù–ò–ï
                </h2>
                
                <div class="game-controls">
                    <button class="game-button btn-primary" id="startWaveBtn">
                        <i class="fas fa-play"></i> –ù–ê–ß–ê–¢–¨ –í–û–õ–ù–£
                    </button>
                    
                    <button class="game-button btn-warning" id="upgradeTowerBtn">
                        <i class="fas fa-arrow-up"></i> –£–õ–£–ß–®–ò–¢–¨ –ë–ê–®–ù–Æ
                    </button>
                    
                    <button class="game-button btn-info" id="pauseGameBtn">
                        <i class="fas fa-pause"></i> –ü–ê–£–ó–ê
                    </button>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                        <button class="game-button" onclick="showModal('helpModal')" 
                                style="background: #6a11cb; color: white; font-size: 0.9rem;">
                            <i class="fas fa-question-circle"></i> –ü–æ–º–æ—â—å
                        </button>
                        
                        <button class="game-button" onclick="showModal('recordsModal')"
                                style="background: #2575fc; color: white; font-size: 0.9rem;">
                            <i class="fas fa-trophy"></i> –†–µ–∫–æ—Ä–¥—ã
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ö–æ–ª—Å—Ç–∞
        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω 800x550 ‚âà 1.45
            const targetRatio = 800 / 550;
            let width = containerWidth;
            let height = containerWidth / targetRatio;
            
            if (height > containerHeight) {
                height = containerHeight;
                width = containerHeight * targetRatio;
            }
            
            canvas.width = Math.floor(width);
            canvas.height = Math.floor(height);
            updateEnemyPath();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –≤—Ä–∞–≥–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ö–æ–ª—Å—Ç–∞
        function updateEnemyPath() {
            const width = canvas.width;
            const height = canvas.height;
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø—É—Ç—å –≤—Ä–∞–≥–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ö–æ–ª—Å—Ç–∞
            const scaleX = width / 800;
            const scaleY = height / 550;
            
            enemyPath = [
                {x: -20 * scaleX, y: 150 * scaleY},
                {x: 120 * scaleX, y: 150 * scaleY},
                {x: 120 * scaleX, y: 80 * scaleY},
                {x: 250 * scaleX, y: 80 * scaleY},
                {x: 250 * scaleX, y: 200 * scaleY},
                {x: 400 * scaleX, y: 200 * scaleY},
                {x: 400 * scaleX, y: 100 * scaleY},
                {x: 550 * scaleX, y: 100 * scaleY},
                {x: 550 * scaleX, y: 250 * scaleY},
                {x: 700 * scaleX, y: 250 * scaleY},
                {x: 700 * scaleX, y: 150 * scaleY},
                {x: (width + 20) * scaleX, y: 150 * scaleY}
            ];
        }
        
        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let gameState = {
            gold: 200,
            lives: 25,
            maxLives: 25,
            score: 0,
            wave: 1,
            totalWaves: 15,
            enemiesKilled: 0,
            enemiesInWave: 6,
            enemiesAlive: 0,
            gameRunning: false,
            gamePaused: false,
            selectedTower: 'basic',
            selectedTowerCost: 60,
            towerLevel: 1,
            upgradeCost: 120,
            selectedTowerForUpgrade: null,
            waveStartTime: 0,
            waveDuration: 60000,
            gameOver: false
        };
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –±–∞—à–µ–Ω
        let draggingTower = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        
        // –ò–≥—Ä–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã
        const towers = [];
        const enemies = [];
        const projectiles = [];
        const particles = [];
        const effects = [];
        
        // –ü—É—Ç—å –≤—Ä–∞–≥–æ–≤ (–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞)
        let enemyPath = [];
        
        // –ö–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –±–∞—à–µ–Ω
        const upgradeImages = {
            basic: 'https://images.unsplash.com/photo-1618331833071-1c0c6ee3d19d?w=400&h=400&fit=crop&crop=center',
            sniper: 'https://images.unsplash.com/photo-1595263181615-2c8c1b8b9a3e?w=400&h=400&fit=crop&crop=center',
            cannon: 'https://images.unsplash.com/photo-1542744095-fcf48d80b0fd?w=400&h=400&fit=crop&crop=center',
            magic: 'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=400&h=400&fit=crop&crop=center'
        };
        
        // –ù–∞–∑–≤–∞–Ω–∏—è –±–∞—à–µ–Ω
        const towerNames = {
            basic: '–°—Ç—Ä–µ–ª–∫–æ–≤–∞—è –±–∞—à–Ω—è',
            sniper: '–°–Ω–∞–π–ø–µ—Ä—Å–∫–∞—è –±–∞—à–Ω—è',
            cannon: '–ê—Ä—Ç–∏–ª–ª–µ—Ä–∏–π—Å–∫–∞—è –±–∞—à–Ω—è',
            magic: '–ú–∞–≥–∏—á–µ—Å–∫–∞—è –±–∞—à–Ω—è'
        };
        
        // ==================== –°–ò–°–¢–ï–ú–ê –ß–ê–°–¢–ò–¶ ====================
        class Particle {
            constructor(x, y, color, velocity, size = 2, life = 60) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.velocity = velocity;
                this.size = size;
                this.life = life;
                this.maxLife = life;
                this.gravity = 0.1;
                this.alpha = 1;
            }
            
            update() {
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.velocity.y += this.gravity;
                this.life--;
                this.alpha = this.life / this.maxLife;
                return this.life > 0;
            }
            
            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ–Ω–æ–≤—ã—Ö —á–∞—Å—Ç–∏—Ü
        function createBackgroundParticles() {
            const particlesContainer = document.getElementById('particles');
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: absolute;
                    width: ${Math.random() * 2 + 1}px;
                    height: ${Math.random() * 2 + 1}px;
                    background-color: rgba(${Math.random() * 55 + 200}, ${Math.random() * 55 + 165}, ${Math.random() * 55 + 32}, ${Math.random() * 0.3 + 0.1});
                    border-radius: 50%;
                    left: ${Math.random() * 100}vw;
                    top: ${Math.random() * 100}vh;
                    box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
                    pointer-events: none;
                `;
                
                particle.animate([
                    { transform: 'translateY(0px)', opacity: 0 },
                    { transform: `translateY(${Math.random() * -100 - 50}px)`, opacity: 0.8 },
                    { transform: `translateY(${Math.random() * -200 - 100}px)`, opacity: 0 }
                ], {
                    duration: Math.random() * 3000 + 2000,
                    delay: Math.random() * 2000,
                    iterations: Infinity
                });
                
                fragment.appendChild(particle);
            }
            
            particlesContainer.appendChild(fragment);
        }
        
        // ==================== –ö–õ–ê–°–°–´ –ò–ì–†–û–í–´–• –û–ë–™–ï–ö–¢–û–í ====================
        
        // –ö–ª–∞—Å—Å –±–∞—à–Ω–∏
        class Tower {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.level = 1;
                this.data = TOWER_DATA[type];
                this.range = this.getRange();
                this.damage = this.getDamage();
                this.fireRate = this.getFireRate();
                this.cooldown = 0;
                this.upgradeCost = 120;
                this.target = null;
                this.rotation = 0;
                this.id = Math.random().toString(36).substr(2, 9);
            }
            
            getRange() {
                return this.data.range * (1 + (this.level - 1) * 0.2);
            }
            
            getDamage() {
                return this.data.damage * (1 + (this.level - 1) * 0.5);
            }
            
            getFireRate() {
                return Math.max(10, this.data.fireRate * (1 - (this.level - 1) * 0.1));
            }
            
            update() {
                if (this.cooldown > 0) {
                    this.cooldown--;
                    return;
                }
                
                this.findTarget();
                
                if (this.target && this.target.health > 0) {
                    this.shoot();
                    this.cooldown = this.fireRate;
                    this.createMuzzleFlash();
                }
            }
            
            findTarget() {
                let closestEnemy = null;
                let minDistance = this.range;
                const rangeSquared = this.range * this.range;
                
                for (const enemy of enemies) {
                    if (enemy.health <= 0) continue;
                    
                    const dx = enemy.x - this.x;
                    const dy = enemy.y - this.y;
                    const distanceSquared = dx * dx + dy * dy;
                    
                    if (distanceSquared < rangeSquared && distanceSquared < minDistance * minDistance) {
                        minDistance = Math.sqrt(distanceSquared);
                        closestEnemy = enemy;
                    }
                }
                
                this.target = closestEnemy;
                
                if (this.target) {
                    const dx = this.target.x - this.x;
                    const dy = this.target.y - this.y;
                    this.rotation = Math.atan2(dy, dx);
                }
            }
            
            shoot() {
                if (!this.target) return;
                
                const projectile = new Projectile(
                    this.x,
                    this.y,
                    this.target,
                    this.damage,
                    this.type,
                    this.data.projectileColor,
                    this.level
                );
                
                projectiles.push(projectile);
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ –≤—ã—Å—Ç—Ä–µ–ª–∞
                for (let i = 0; i < 3; i++) {
                    particles.push(new Particle(
                        this.x,
                        this.y,
                        this.data.projectileColor,
                        {
                            x: (Math.random() - 0.5) * 4,
                            y: (Math.random() - 0.5) * 4
                        },
                        Math.random() * 2 + 1,
                        30
                    ));
                }
            }
            
            createMuzzleFlash() {
                effects.push({
                    type: 'muzzleFlash',
                    x: this.x + Math.cos(this.rotation) * 25,
                    y: this.y + Math.sin(this.rotation) * 25,
                    rotation: this.rotation,
                    life: 10,
                    size: 15
                });
            }
            
            draw() {
                const scale = canvas.width / 800;
                
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.scale(scale, scale);
                ctx.rotate(this.rotation);
                
                // –ö–æ—Ä–ø—É—Å –±–∞—à–Ω–∏
                ctx.fillStyle = this.data.color;
                ctx.beginPath();
                ctx.arc(0, 0, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // –î–µ—Ç–∞–ª–∏
                ctx.fillStyle = '#222';
                ctx.beginPath();
                ctx.arc(0, 0, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // –°—Ç–≤–æ–ª –±–∞—à–Ω–∏
                ctx.fillStyle = '#444';
                ctx.fillRect(15, -5, 25, 10);
                
                ctx.restore();
                
                // –£—Ä–æ–≤–µ–Ω—å –±–∞—à–Ω–∏
                ctx.fillStyle = '#FFD700';
                ctx.font = `bold ${14 * scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(this.level.toString(), this.x, this.y + 30 * scale);
                
                // –†–∞–¥–∏—É—Å –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
                if (gameState.selectedTowerForUpgrade === this) {
                    ctx.strokeStyle = `${this.data.color}80`;
                    ctx.lineWidth = 2 * scale;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.range, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
            
            upgrade() {
                const oldLevel = this.level;
                const oldDamage = this.damage;
                const oldRange = this.range;
                const oldFireRate = this.fireRate;
                
                this.level++;
                this.range = this.getRange();
                this.damage = this.getDamage();
                this.fireRate = this.getFireRate();
                this.upgradeCost = Math.floor(this.upgradeCost * 1.5);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ —É–ª—É—á—à–µ–Ω–∏—è
                showUpgradeModal(this, oldLevel, oldDamage, oldRange, oldFireRate);
                
                // –≠—Ñ—Ñ–µ–∫—Ç —É–ª—É—á—à–µ–Ω–∏—è
                for (let i = 0; i < 15; i++) {
                    particles.push(new Particle(
                        this.x,
                        this.y,
                        '#FFD700',
                        {
                            x: (Math.random() - 0.5) * 6,
                            y: (Math.random() - 0.5) * 6
                        },
                        Math.random() * 3 + 2,
                        60
                    ));
                }
                
                showMessage(`–ë–∞—à–Ω—è —É–ª—É—á—à–µ–Ω–∞ –¥–æ —É—Ä–æ–≤–Ω—è ${this.level}!`);
                updateUI();
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ª—É—á—à–µ–Ω–∏—è
        function showUpgradeModal(tower, oldLevel, oldDamage, oldRange, oldFireRate) {
            const modal = document.getElementById('upgradeModal');
            const image = document.getElementById('upgradeTowerImage');
            const name = document.getElementById('upgradeTowerName');
            const newLevel = document.getElementById('newTowerLevel');
            const newDamage = document.getElementById('newDamage');
            const newRange = document.getElementById('newRange');
            const newSpeed = document.getElementById('newSpeed');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            image.src = upgradeImages[tower.type] || upgradeImages.basic;
            image.alt = towerNames[tower.type];
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            name.textContent = `${towerNames[tower.type]} —É–ª—É—á—à–µ–Ω–∞!`;
            newLevel.textContent = tower.level;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã —É–ª—É—á—à–µ–Ω–∏—è
            const damageIncrease = Math.round(((tower.damage - oldDamage) / oldDamage) * 100);
            const rangeIncrease = Math.round(((tower.range - oldRange) / oldRange) * 100);
            const speedIncrease = Math.round(((oldFireRate - tower.fireRate) / oldFireRate) * 100);
            
            newDamage.textContent = `+${damageIncrease}%`;
            newRange.textContent = `+${rangeIncrease}%`;
            newSpeed.textContent = `+${speedIncrease}%`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            modal.style.display = 'flex';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (modal.style.display === 'flex') {
                    closeModal('upgradeModal');
                }
            }, 5000);
        }
        
        // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–∞—à–µ–Ω
        const TOWER_DATA = {
            basic: { damage: 15, range: 140, fireRate: 60, color: '#32CD32', projectileColor: '#00FF00' },
            sniper: { damage: 35, range: 220, fireRate: 120, color: '#1E90FF', projectileColor: '#4169E1' },
            cannon: { damage: 50, range: 110, fireRate: 150, color: '#FF4500', projectileColor: '#FF8C00' },
            magic: { damage: 20, range: 160, fireRate: 30, color: '#BA55D3', projectileColor: '#FF00FF' }
        };
        
        const ENEMY_DATA = {
            basic: { speed: 1.2, health: 40, reward: 15, color: '#FF6347', icon: 'üë•' },
            fast: { speed: 2.0, health: 25, reward: 20, color: '#00CED1', icon: '‚ö°' },
            tank: { speed: 0.8, health: 120, reward: 40, color: '#696969', icon: 'üõ°Ô∏è' }
        };
        
        // –ö–ª–∞—Å—Å –≤—Ä–∞–≥–∞
        class Enemy {
            constructor(type, wave) {
                this.type = type;
                this.wave = wave;
                this.pathIndex = 0;
                this.x = enemyPath[0].x;
                this.y = enemyPath[0].y;
                this.data = ENEMY_DATA[type] || ENEMY_DATA.basic;
                this.speed = this.getSpeed();
                this.health = this.getHealth();
                this.maxHealth = this.health;
                this.reward = this.getReward();
                this.slowDuration = 0;
                this.id = Math.random().toString(36).substr(2, 9);
                this.isBoss = wave % 5 === 0;
                
                if (this.isBoss) {
                    this.health *= 3;
                    this.maxHealth = this.health;
                    this.reward *= 5;
                    this.speed *= 0.7;
                }
            }
            
            getSpeed() {
                return this.data.speed * (1 + (this.wave - 1) * 0.05);
            }
            
            getHealth() {
                return Math.floor(this.data.health * (1 + (this.wave - 1) * 0.2));
            }
            
            getReward() {
                return this.data.reward;
            }
            
            update() {
                let effectiveSpeed = this.speed;
                if (this.slowDuration > 0) {
                    effectiveSpeed *= 0.5;
                    this.slowDuration--;
                }
                
                if (this.pathIndex >= enemyPath.length - 1) {
                    gameState.lives--;
                    if (gameState.lives <= 0 && !gameState.gameOver) {
                        gameState.gameOver = true;
                        gameOver();
                    } else if (gameState.lives <= 0) {
                        return false;
                    } else {
                        showMessage(`–í—Ä–∞–≥ –¥–æ—Å—Ç–∏–≥ –∑–∞–º–∫–∞! –û—Å—Ç–∞–ª–æ—Å—å –∂–∏–∑–Ω–µ–π: ${gameState.lives}`);
                    }
                    return false;
                }
                
                const target = enemyPath[this.pathIndex + 1];
                const dx = target.x - this.x;
                const dy = target.y - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < effectiveSpeed) {
                    this.pathIndex++;
                } else {
                    this.x += (dx / distance) * effectiveSpeed;
                    this.y += (dy / distance) * effectiveSpeed;
                }
                
                return this.health > 0;
            }
            
            draw() {
                const scale = canvas.width / 800;
                
                // –¢–µ–ª–æ –≤—Ä–∞–≥–∞
                ctx.fillStyle = this.data.color;
                ctx.beginPath();
                
                const radius = (this.isBoss ? 18 : 12) * scale;
                ctx.arc(this.x, this.y, radius, 0, Math.PI * 2);
                ctx.fill();
                
                if (this.isBoss) {
                    // –ö–æ—Ä–æ–Ω–∞ –¥–ª—è –±–æ—Å—Å–∞
                    ctx.save();
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.moveTo(this.x - 15 * scale, this.y - 15 * scale);
                    ctx.lineTo(this.x - 5 * scale, this.y - 25 * scale);
                    ctx.lineTo(this.x + 5 * scale, this.y - 15 * scale);
                    ctx.lineTo(this.x + 15 * scale, this.y - 25 * scale);
                    ctx.lineTo(this.x + 25 * scale, this.y - 15 * scale);
                    ctx.lineTo(this.x + 15 * scale, this.y - 5 * scale);
                    ctx.lineTo(this.x - 15 * scale, this.y - 15 * scale);
                    ctx.fill();
                    ctx.restore();
                }
                
                // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
                const healthWidth = (this.isBoss ? 40 : 30) * scale;
                const healthPercent = this.health / this.maxHealth;
                
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(this.x - healthWidth/2, this.y - 25 * scale, healthWidth, 5 * scale);
                
                ctx.fillStyle = healthPercent > 0.5 ? '#00FF00' : '#FFA500';
                ctx.fillRect(this.x - healthWidth/2, this.y - 25 * scale, healthWidth * healthPercent, 5 * scale);
                
                // –ú–∞—Ç–æ–≤–∞—è –∏–∫–æ–Ω–∫–∞ —Ç–∏–ø–∞
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = `bold ${12 * scale}px Arial`;
                ctx.textAlign = 'center';
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞—Ç–æ–≤—ã–µ –∏–∫–æ–Ω–∫–∏
                const icon = this.data.icon;
                
                ctx.fillText(icon, this.x, this.y + 5 * scale);
                
                // –≠—Ñ—Ñ–µ–∫—Ç –∑–∞–º–µ–¥–ª–µ–Ω–∏—è
                if (this.slowDuration > 0) {
                    ctx.strokeStyle = '#00BFFF';
                    ctx.lineWidth = 2 * scale;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 15 * scale, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
            
            takeDamage(damage, effect = null) {
                this.health -= damage;
                
                // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ–ø–∞–¥–∞–Ω–∏—è
                for (let i = 0; i < 3; i++) {
                    particles.push(new Particle(
                        this.x,
                        this.y,
                        this.data.color,
                        {
                            x: (Math.random() - 0.5) * 4,
                            y: (Math.random() - 0.5) * 4
                        },
                        Math.random() * 2 + 1,
                        20
                    ));
                }
                
                if (effect === 'slow') {
                    this.slowDuration = 60;
                }
                
                if (this.health <= 0) {
                    this.onDeath();
                    return false;
                }
                return true;
            }
            
            onDeath() {
                gameState.gold += this.reward;
                gameState.score += this.reward * 10;
                gameState.enemiesKilled++;
                gameState.enemiesAlive--;
                
                // –≠—Ñ—Ñ–µ–∫—Ç —Å–º–µ—Ä—Ç–∏
                for (let i = 0; i < 10; i++) {
                    particles.push(new Particle(
                        this.x,
                        this.y,
                        this.data.color,
                        {
                            x: (Math.random() - 0.5) * 8,
                            y: (Math.random() - 0.5) * 8
                        },
                        Math.random() * 3 + 2,
                        40
                    ));
                }
                
                if (this.isBoss) {
                    showMessage(`–ë–û–°–° –£–ù–ò–ß–¢–û–ñ–ï–ù! +${this.reward} –∑–æ–ª–æ—Ç–∞`);
                    for (let i = 0; i < 20; i++) {
                        particles.push(new Particle(
                            this.x,
                            this.y,
                            '#FFD700',
                            {
                                x: (Math.random() - 0.5) * 10,
                                y: (Math.random() - 0.5) * 10
                            },
                            Math.random() * 4 + 3,
                            60
                        ));
                    }
                }
            }
        }
        
        // –ö–ª–∞—Å—Å —Å–Ω–∞—Ä—è–¥–∞
        class Projectile {
            constructor(x, y, target, damage, type, color, level) {
                this.x = x;
                this.y = y;
                this.target = target;
                this.damage = damage;
                this.type = type;
                this.color = color;
                this.level = level;
                this.speed = 7;
                this.size = 6 + level;
                this.trail = [];
                this.maxTrailLength = 5;
            }
            
            update() {
                if (!this.target || this.target.health <= 0) {
                    return false;
                }
                
                // –°–ª–µ–¥ —Å–Ω–∞—Ä—è–¥–∞
                this.trail.push({x: this.x, y: this.y});
                if (this.trail.length > this.maxTrailLength) {
                    this.trail.shift();
                }
                
                // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏
                const dx = this.target.x - this.x;
                const dy = this.target.y - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < this.speed) {
                    this.onHit();
                    return false;
                } else {
                    this.x += (dx / distance) * this.speed;
                    this.y += (dy / distance) * this.speed;
                    return true;
                }
            }
            
            onHit() {
                let effect = null;
                
                switch(this.type) {
                    case 'cannon':
                        // –í–∑—Ä—ã–≤–Ω–∞—è –∞—Ç–∞–∫–∞
                        for (let enemy of enemies) {
                            const dx = enemy.x - this.target.x;
                            const dy = enemy.y - this.target.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < 50 && enemy.health > 0) {
                                enemy.takeDamage(this.damage * 0.5);
                            }
                        }
                        effect = 'explosion';
                        break;
                        
                    case 'magic':
                        effect = 'slow';
                        break;
                }
                
                this.target.takeDamage(this.damage, effect);
                
                if (effect === 'explosion') {
                    for (let i = 0; i < 10; i++) {
                        particles.push(new Particle(
                            this.target.x,
                            this.target.y,
                            '#FF8C00',
                            {
                                x: (Math.random() - 0.5) * 8,
                                y: (Math.random() - 0.5) * 8
                            },
                            Math.random() * 4 + 2,
                            40
                        ));
                    }
                }
            }
            
            draw() {
                const scale = canvas.width / 800;
                
                // –°–ª–µ–¥ —Å–Ω–∞—Ä—è–¥–∞
                for (let i = 0; i < this.trail.length; i++) {
                    const point = this.trail[i];
                    const alpha = i / this.trail.length;
                    
                    ctx.save();
                    ctx.globalAlpha = alpha * 0.5;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, this.size * alpha * scale, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
                
                // –°–Ω–∞—Ä—è–¥
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size * scale, 0, Math.PI * 2);
                ctx.fill();
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 15 * scale;
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }
        
        // ==================== –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ====================
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            document.getElementById('goldAmount').textContent = gameState.gold;
            document.getElementById('livesCount').textContent = gameState.lives;
            document.getElementById('waveNumber').textContent = `${gameState.wave}/${gameState.totalWaves}`;
            document.getElementById('enemiesKilled').textContent = gameState.enemiesKilled;
            document.getElementById('scoreValue').textContent = gameState.score;
            
            document.getElementById('selectedTowerName').textContent = towerNames[gameState.selectedTower];
            document.getElementById('towerLevel').textContent = gameState.towerLevel;
            document.getElementById('upgradeCost').textContent = gameState.upgradeCost;
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–æ–ª–Ω—ã
            const progress = gameState.enemiesAlive / gameState.enemiesInWave;
            const progressPercent = Math.max(0, (1 - progress) * 100);
            document.getElementById('waveProgressBar').style.width = `${progressPercent}%`;
            document.getElementById('waveProgressText').textContent = 
                `${gameState.enemiesInWave - gameState.enemiesAlive}/${gameState.enemiesInWave}`;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text) {
            const messageElement = document.getElementById('gameMessage');
            messageElement.textContent = text;
            
            messageElement.style.animation = 'none';
            setTimeout(() => {
                messageElement.style.animation = 'pulse 2s infinite';
            }, 10);
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
        function drawGameField() {
            // –§–æ–Ω
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0a0a1a');
            gradient.addColorStop(1, '#1a1a2e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –ü—É—Ç—å –≤—Ä–∞–≥–æ–≤
            if (enemyPath.length > 0) {
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 35 * (canvas.width / 800);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();
                
                for (let i = 0; i < enemyPath.length; i++) {
                    if (i === 0) {
                        ctx.moveTo(enemyPath[i].x, enemyPath[i].y);
                    } else {
                        ctx.lineTo(enemyPath[i].x, enemyPath[i].y);
                    }
                }
                ctx.stroke();
                
                // –¢–æ—á–∫–∏ –ø—É—Ç–∏
                ctx.fillStyle = '#FFD700';
                for (const point of enemyPath) {
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 8 * (canvas.width / 800), 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // –ó–∞–º–æ–∫
                drawCastle();
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–º–∫–∞
        function drawCastle() {
            if (enemyPath.length === 0) return;
            
            const scale = canvas.width / 800;
            const castleX = enemyPath[enemyPath.length - 1].x - 60 * scale;
            const castleY = enemyPath[enemyPath.length - 1].y - 40 * scale;
            
            // –û—Å–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–º–∫–∞
            ctx.fillStyle = '#2F4F4F';
            ctx.fillRect(castleX, castleY, 60 * scale, 80 * scale);
            
            // –ë–∞—à–Ω–∏ –∑–∞–º–∫–∞
            ctx.fillStyle = '#696969';
            ctx.fillRect(castleX - 10 * scale, castleY - 20 * scale, 20 * scale, 20 * scale);
            ctx.fillRect(castleX + 50 * scale, castleY - 20 * scale, 20 * scale, 20 * scale);
            
            // –ö—Ä—ã—à–∏
            ctx.fillStyle = '#8B0000';
            ctx.beginPath();
            ctx.moveTo(castleX - 15 * scale, castleY - 20 * scale);
            ctx.lineTo(castleX + 5 * scale, castleY - 40 * scale);
            ctx.lineTo(castleX + 25 * scale, castleY - 20 * scale);
            ctx.closePath();
            ctx.fill();
            
            // –í–æ—Ä–æ—Ç–∞
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(castleX + 20 * scale, castleY + 20 * scale, 20 * scale, 40 * scale);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        function updateAndDrawEffects() {
            for (let i = effects.length - 1; i >= 0; i--) {
                const effect = effects[i];
                
                if (effect.type === 'muzzleFlash') {
                    ctx.save();
                    ctx.translate(effect.x, effect.y);
                    ctx.rotate(effect.rotation);
                    
                    ctx.fillStyle = `rgba(255, 255, 200, ${effect.life / 10})`;
                    ctx.beginPath();
                    ctx.arc(0, 0, effect.size * (canvas.width / 800), 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.restore();
                }
                
                effect.life--;
                if (effect.life <= 0) {
                    effects.splice(i, 1);
                }
            }
        }
        
        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        let lastTime = 0;
        function gameLoop(currentTime) {
            if (!lastTime) lastTime = currentTime;
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            if (gameState.gamePaused || !gameState.gameRunning || gameState.gameOver) {
                requestAnimationFrame(gameLoop);
                return;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º FPS –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            if (deltaTime < 16) { // ~60 FPS
                requestAnimationFrame(gameLoop);
                return;
            }
            
            // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
            drawGameField();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —á–∞—Å—Ç–∏—Ü
            for (let i = particles.length - 1; i >= 0; i--) {
                if (!particles[i].update()) {
                    particles.splice(i, 1);
                } else {
                    particles[i].draw();
                }
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–∞—à–µ–Ω
            for (const tower of towers) {
                tower.update();
                tower.draw();
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Ä–∞–≥–æ–≤
            for (let i = enemies.length - 1; i >= 0; i--) {
                if (!enemies[i].update()) {
                    enemies.splice(i, 1);
                } else {
                    enemies[i].draw();
                }
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–Ω–∞—Ä—è–¥–æ–≤
            for (let i = projectiles.length - 1; i >= 0; i--) {
                if (!projectiles[i].update()) {
                    projectiles.splice(i, 1);
                } else {
                    projectiles[i].draw();
                }
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
            updateAndDrawEffects();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ–ª–Ω—ã
            if (enemies.length === 0 && gameState.enemiesAlive === 0 && gameState.gameRunning) {
                if (gameState.wave > gameState.totalWaves) {
                    victory();
                } else {
                    showMessage(`–í–æ–ª–Ω–∞ ${gameState.wave - 1} –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –≤–æ–ª–Ω–µ ${gameState.wave}`);
                    gameState.gameRunning = false;
                    document.getElementById('startWaveBtn').innerHTML = '<i class="fas fa-play"></i> –ù–ê–ß–ê–¢–¨ –í–û–õ–ù–£';
                }
            }
            
            updateUI();
            requestAnimationFrame(gameLoop);
        }
        
        // –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã
        function startWave() {
            if (gameState.gameRunning || gameState.gameOver) return;
            
            gameState.gameRunning = true;
            gameState.enemiesAlive = gameState.enemiesInWave;
            
            const enemyTypes = ['basic', 'fast', 'tank'];
            
            for (let i = 0; i < gameState.enemiesInWave; i++) {
                let typeIndex = 0;
                if (gameState.wave > 3) typeIndex = Math.floor(Math.random() * 2);
                if (gameState.wave > 6) typeIndex = Math.floor(Math.random() * 3);
                
                setTimeout(() => {
                    enemies.push(new Enemy(enemyTypes[typeIndex], gameState.wave));
                }, i * 800);
            }
            
            showMessage(`–í–æ–ª–Ω–∞ ${gameState.wave} –Ω–∞—á–∞–ª–∞—Å—å! –£–Ω–∏—á—Ç–æ–∂—å—Ç–µ ${gameState.enemiesInWave} –≤—Ä–∞–≥–æ–≤!`);
            
            gameState.wave++;
            gameState.enemiesInWave = Math.floor(6 + (gameState.wave - 1) * 1.2);
            
            document.getElementById('startWaveBtn').innerHTML = '<i class="fas fa-sync-alt"></i> –í–û–õ–ù–ê –ò–î–Å–¢...';
        }
        
        // –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
        function gameOver() {
            gameState.gameRunning = false;
            gameState.gameOver = true;
            showMessage(`–ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –í—ã –¥–æ—à–ª–∏ –¥–æ –≤–æ–ª–Ω—ã ${gameState.wave - 1}. –°—á—ë—Ç: ${gameState.score}. –ù–∞–∂–º–∏—Ç–µ "–ü–†–û–î–û–õ–ñ–ò–¢–¨" —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É`);
            
            saveScore(gameState.score, gameState.wave - 1);
            
            document.getElementById('startWaveBtn').innerHTML = '<i class="fas fa-redo"></i> –ü–†–û–î–û–õ–ñ–ò–¢–¨';
            document.getElementById('startWaveBtn').disabled = false;
        }
        
        // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É –ø–æ—Å–ª–µ –ø–æ—Ä–∞–∂–µ–Ω–∏—è
        function continueGame() {
            if (gameState.gameOver) {
                gameState.gameOver = false;
                gameState.lives = Math.floor(gameState.maxLives / 2);
                showMessage(`–ò–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∞! –£ –≤–∞—Å ${gameState.lives} –∂–∏–∑–Ω–µ–π. –í–æ–ª–Ω–∞ ${gameState.wave - 1}`);
                updateUI();
            }
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∂–∏–∑–Ω–∏
        function restoreLives() {
            if (gameState.gold >= 50 && gameState.lives < gameState.maxLives) {
                gameState.gold -= 50;
                gameState.lives = Math.min(gameState.maxLives, gameState.lives + 10);
                showMessage(`–ñ–∏–∑–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å ${gameState.lives} –∂–∏–∑–Ω–µ–π`);
                updateUI();
                
                // –≠—Ñ—Ñ–µ–∫—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                for (let i = 0; i < 20; i++) {
                    particles.push(new Particle(
                        canvas.width / 2,
                        canvas.height / 2,
                        '#FF4444',
                        {
                            x: (Math.random() - 0.5) * 10,
                            y: (Math.random() - 0.5) * 10
                        },
                        Math.random() * 3 + 2,
                        60
                    ));
                }
            } else if (gameState.gold < 50) {
                showMessage(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞! –ù—É–∂–Ω–æ 50, —É –≤–∞—Å ${gameState.gold}`);
            } else {
                showMessage(`–£ –≤–∞—Å —É–∂–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–∏–∑–Ω–µ–π!`);
            }
        }
        
        // –ü–æ–±–µ–¥–∞
        function victory() {
            gameState.gameRunning = false;
            showMessage(`–ü–û–ë–ï–î–ê! –í—ã –∑–∞—â–∏—Ç–∏–ª–∏ –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ! –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á—ë—Ç: ${gameState.score}`);
            
            saveScore(gameState.score, gameState.wave - 1);
            
            setTimeout(() => {
                alert(`–ü–û–ë–ï–î–ê! –í—ã –∑–∞—â–∏—Ç–∏–ª–∏ –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ! –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á—ë—Ç: ${gameState.score}`);
                resetGame();
            }, 100);
        }
        
        // –°–±—Ä–æ—Å –∏–≥—Ä—ã
        function resetGame() {
            gameState = {
                gold: 200,
                lives: 25,
                maxLives: 25,
                score: 0,
                wave: 1,
                totalWaves: 15,
                enemiesKilled: 0,
                enemiesInWave: 6,
                enemiesAlive: 0,
                gameRunning: false,
                gamePaused: false,
                selectedTower: 'basic',
                selectedTowerCost: 60,
                towerLevel: 1,
                upgradeCost: 120,
                selectedTowerForUpgrade: null,
                waveStartTime: 0,
                waveDuration: 60000,
                gameOver: false
            };
            
            towers.length = 0;
            enemies.length = 0;
            projectiles.length = 0;
            particles.length = 0;
            effects.length = 0;
            
            updateUI();
            showMessage("–ò–≥—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞. –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –±–∞—à–Ω—é –Ω–∞ –ø–æ–ª–µ –¥–ª—è –∑–∞—â–∏—Ç—ã!");
        }
        
        // ==================== –°–ò–°–¢–ï–ú–ê –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø –ë–ê–®–ï–ù ====================
        
        // –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        document.querySelectorAll('.draggable-tower').forEach(tower => {
            tower.addEventListener('dragstart', (e) => {
                if (!gameState.gameRunning) {
                    showMessage("–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–æ–ª–Ω—É!");
                    e.preventDefault();
                    return;
                }
                
                if (gameState.gold < parseInt(tower.dataset.cost)) {
                    showMessage(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞! –ù—É–∂–Ω–æ ${tower.dataset.cost}, —É –≤–∞—Å ${gameState.gold}`);
                    e.preventDefault();
                    return;
                }
                
                draggingTower = {
                    type: tower.dataset.type,
                    cost: parseInt(tower.dataset.cost),
                    icon: tower.querySelector('span').textContent
                };
                
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                const dragImage = document.createElement('div');
                dragImage.textContent = tower.querySelector('span').textContent;
                dragImage.style.cssText = `
                    font-size: 24px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    background: ${getTowerColor(tower.dataset.type)};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: fixed;
                    top: -100px;
                    left: -100px;
                    opacity: 0.8;
                `;
                document.body.appendChild(dragImage);
                e.dataTransfer.setDragImage(dragImage, 25, 25);
                
                setTimeout(() => document.body.removeChild(dragImage), 0);
            });
            
            tower.addEventListener('touchstart', (e) => {
                if (!gameState.gameRunning) {
                    showMessage("–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–æ–ª–Ω—É!");
                    return;
                }
                
                if (gameState.gold < parseInt(tower.dataset.cost)) {
                    showMessage(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞! –ù—É–∂–Ω–æ ${tower.dataset.cost}, —É –≤–∞—Å ${gameState.gold}`);
                    return;
                }
                
                draggingTower = {
                    type: tower.dataset.type,
                    cost: parseInt(tower.dataset.cost),
                    icon: tower.querySelector('span').textContent
                };
                
                const touch = e.touches[0];
                dragStartX = touch.clientX;
                dragStartY = touch.clientY;
                
                e.preventDefault();
            });
        });
        
        // –ü–æ–ª—É—á–∏—Ç—å —Ü–≤–µ—Ç –±–∞—à–Ω–∏
        function getTowerColor(type) {
            switch(type) {
                case 'basic': return '#32CD32';
                case 'sniper': return '#1E90FF';
                case 'cannon': return '#FF4500';
                case 'magic': return '#BA55D3';
                default: return '#32CD32';
            }
        }
        
        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –Ω–∞–¥ —Ö–æ–ª—Å—Ç–æ–º
        canvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            canvas.style.borderColor = '#FFD700';
            canvas.style.boxShadow = '0 0 30px rgba(255, 215, 0, 0.7)';
        });
        
        canvas.addEventListener('dragleave', () => {
            canvas.style.borderColor = 'rgba(218, 165, 32, 0.6)';
            canvas.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.6)';
        });
        
        // –ë—Ä–æ—Å–∞–Ω–∏–µ –±–∞—à–Ω–∏ –Ω–∞ —Ö–æ–ª—Å—Ç
        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            
            canvas.style.borderColor = 'rgba(218, 165, 32, 0.6)';
            canvas.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.6)';
            
            if (!draggingTower) return;
            
            const rect = canvas.getBoundingClientRect();
            const scale = canvas.width / rect.width;
            const x = (e.clientX - rect.left) * scale;
            const y = (e.clientY - rect.top) * scale;
            
            placeTower(x, y, draggingTower.type, draggingTower.cost);
            draggingTower = null;
        });
        
        // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        canvas.addEventListener('touchmove', (e) => {
            if (!draggingTower) return;
            
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const scale = canvas.width / rect.width;
            const x = (touch.clientX - rect.left) * scale;
            const y = (touch.clientY - rect.top) * scale;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            drawTowerPreview(x, y, draggingTower.type);
            
            e.preventDefault();
        });
        
        canvas.addEventListener('touchend', (e) => {
            if (!draggingTower) return;
            
            const touch = e.changedTouches[0];
            const rect = canvas.getBoundingClientRect();
            const scale = canvas.width / rect.width;
            const x = (touch.clientX - rect.left) * scale;
            const y = (touch.clientY - rect.top) * scale;
            
            placeTower(x, y, draggingTower.type, draggingTower.cost);
            draggingTower = null;
            
            e.preventDefault();
        });
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±–∞—à–Ω–∏
        function drawTowerPreview(x, y, type) {
            const scale = canvas.width / 800;
            const color = getTowerColor(type);
            
            ctx.save();
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, 20 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
        
        // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –±–∞—à–Ω–∏
        function placeTower(x, y, type, cost) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –Ω–∞ –ø—É—Ç–∏
            const threshold = 40 * (canvas.width / 800);
            let onPath = false;
            
            for (let i = 0; i < enemyPath.length - 1; i++) {
                const A = enemyPath[i];
                const B = enemyPath[i + 1];
                const distance = pointToLineDistance(x, y, A.x, A.y, B.x, B.y);
                
                if (distance < threshold) {
                    onPath = true;
                    break;
                }
            }
            
            if (onPath) {
                showMessage("–ù–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –±–∞—à–Ω–∏ –Ω–∞ –ø—É—Ç–∏ –≤—Ä–∞–≥–æ–≤!");
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –¥—Ä—É–≥–∏—Ö –±–∞—à–µ–Ω
            const minDistance = 60 * (canvas.width / 800);
            for (const tower of towers) {
                const dx = tower.x - x;
                const dy = tower.y - y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < minDistance) {
                    showMessage("–ë–∞—à–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ –Ω–µ –º–µ–Ω–µ–µ 60px –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞!");
                    return;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –ø–æ–ª—è
            if (x < 20 || x > canvas.width - 20 || y < 20 || y > canvas.height - 20) {
                showMessage("–ë–∞—à–Ω—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è!");
                return;
            }
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –±–∞—à–Ω–∏
            towers.push(new Tower(x, y, type));
            gameState.gold -= cost;
            showMessage(`–ë–∞—à–Ω—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞! –û—Å—Ç–∞–ª–æ—Å—å –∑–æ–ª–æ—Ç–∞: ${gameState.gold}`);
            
            // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–π–∫–∏
            for (let i = 0; i < 10; i++) {
                particles.push(new Particle(
                    x, y,
                    getTowerColor(type),
                    {
                        x: (Math.random() - 0.5) * 6,
                        y: (Math.random() - 0.5) * 6
                    },
                    Math.random() * 3 + 2,
                    40
                ));
            }
            
            updateUI();
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –ª–∏–Ω–∏–∏
        function pointToLineDistance(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) param = dot / lenSq;
            
            let xx, yy;
            
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            const dx = px - xx;
            const dy = py - yy;
            
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ —Ö–æ–ª—Å—Ç—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –±–∞—à–Ω–∏
        canvas.addEventListener('click', (e) => {
            if (!gameState.gameRunning) {
                showMessage("–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–æ–ª–Ω—É!");
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const scale = canvas.width / rect.width;
            const x = (e.clientX - rect.left) * scale;
            const y = (e.clientY - rect.top) * scale;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞—à–Ω–µ
            for (const tower of towers) {
                const dx = tower.x - x;
                const dy = tower.y - y;
                const distance = dx * dx + dy * dy;
                const radius = 25 * (canvas.width / 800);
                
                if (distance < radius * radius) {
                    gameState.selectedTowerForUpgrade = tower;
                    gameState.upgradeCost = tower.upgradeCost;
                    showMessage(`–í—ã–±—Ä–∞–Ω–∞ –±–∞—à–Ω—è —É—Ä–æ–≤–Ω—è ${tower.level}. –£–ª—É—á—à–µ–Ω–∏–µ: ${tower.upgradeCost} –∑–æ–ª–æ—Ç–∞`);
                    updateUI();
                    return;
                }
            }
            
            gameState.selectedTowerForUpgrade = null;
        });
        
        // –ù–∞–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –±–∞—à–Ω—é
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scale = canvas.width / rect.width;
            const x = (e.clientX - rect.left) * scale;
            const y = (e.clientY - rect.top) * scale;
            
            let hovered = false;
            const radius = 25 * (canvas.width / 800);
            
            for (const tower of towers) {
                const dx = tower.x - x;
                const dy = tower.y - y;
                const distance = dx * dx + dy * dy;
                
                if (distance < radius * radius) {
                    hovered = true;
                    break;
                }
            }
            
            canvas.style.cursor = hovered ? 'pointer' : 'default';
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('startWaveBtn').addEventListener('click', () => {
            if (gameState.gamePaused) {
                gameState.gamePaused = false;
                showMessage("–ò–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∞!");
                document.getElementById('startWaveBtn').innerHTML = '<i class="fas fa-play"></i> –ù–ê–ß–ê–¢–¨ –í–û–õ–ù–£';
                document.getElementById('pauseGameBtn').innerHTML = '<i class="fas fa-pause"></i> –ü–ê–£–ó–ê';
            } else if (gameState.gameOver) {
                continueGame();
                document.getElementById('startWaveBtn').innerHTML = '<i class="fas fa-play"></i> –ù–ê–ß–ê–¢–¨ –í–û–õ–ù–£';
            } else if (!gameState.gameRunning) {
                startWave();
            }
        });
        
        document.getElementById('pauseGameBtn').addEventListener('click', () => {
            if (gameState.gameRunning) {
                gameState.gamePaused = !gameState.gamePaused;
                if (gameState.gamePaused) {
                    showMessage("–ò–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ");
                    document.getElementById('pauseGameBtn').innerHTML = '<i class="fas fa-play"></i> –ü–†–û–î–û–õ–ñ–ò–¢–¨';
                } else {
                    showMessage("–ò–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∞!");
                    document.getElementById('pauseGameBtn').innerHTML = '<i class="fas fa-pause"></i> –ü–ê–£–ó–ê';
                }
            } else {
                showMessage("–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–æ–ª–Ω—É!");
            }
        });
        
        document.getElementById('upgradeTowerBtn').addEventListener('click', () => {
            if (!gameState.selectedTowerForUpgrade) {
                showMessage("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞—à–Ω—é, –∫–ª–∏–∫–Ω—É–≤ –ø–æ –Ω–µ–π!");
                return;
            }
            
            if (gameState.gold < gameState.upgradeCost) {
                showMessage(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è! –ù—É–∂–Ω–æ ${gameState.upgradeCost}, —É –≤–∞—Å ${gameState.gold}`);
                return;
            }
            
            gameState.selectedTowerForUpgrade.upgrade();
            gameState.gold -= gameState.upgradeCost;
            gameState.towerLevel = gameState.selectedTowerForUpgrade.level;
            updateUI();
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–π
        document.getElementById('restoreLivesBtn').addEventListener('click', restoreLives);
        
        // –í—ã–±–æ—Ä –±–∞—à–µ–Ω
        document.querySelectorAll('.tower-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.tower-card').forEach(c => {
                    c.classList.remove('active');
                });
                
                card.classList.add('active');
                gameState.selectedTower = card.dataset.tower;
                gameState.selectedTowerCost = parseInt(card.dataset.cost);
                
                const towerName = card.querySelector('.tower-name').textContent.trim();
                showMessage(`–í—ã–±—Ä–∞–Ω–∞ ${towerName}`);
                updateUI();
            });
        });
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function saveScore(score, wave) {
            try {
                const records = JSON.parse(localStorage.getItem('tdRecords') || '[]');
                const record = {
                    score: score,
                    wave: wave,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString()
                };
                
                records.push(record);
                records.sort((a, b) => b.score - a.score);
                
                if (records.length > 10) records.length = 10;
                
                localStorage.setItem('tdRecords', JSON.stringify(records));
                updateRecordsDisplay();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–∞:', e);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–∫–æ—Ä–¥–æ–≤
        function updateRecordsDisplay() {
            try {
                const records = JSON.parse(localStorage.getItem('tdRecords') || '[]');
                const recordsList = document.getElementById('recordsList');
                
                if (records.length === 0) {
                    recordsList.innerHTML = '<p style="text-align: center; color: #aaa;">–†–µ–∫–æ—Ä–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                    return;
                }
                
                let html = '<div style="overflow-x: auto;">';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: rgba(255, 215, 0, 0.1);">';
                html += '<th style="padding: 10px; text-align: left; color: #ffd700;">#</th>';
                html += '<th style="padding: 10px; text-align: left; color: #ffd700;">–°—á—ë—Ç</th>';
                html += '<th style="padding: 10px; text-align: left; color: #ffd700;">–í–æ–ª–Ω–∞</th>';
                html += '<th style="padding: 10px; text-align: left; color: #ffd700;">–î–∞—Ç–∞</th>';
                html += '</tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
                    html += `<tr style="border-bottom: 1px solid rgba(255, 215, 0, 0.2);">`;
                    html += `<td style="padding: 10px;">${medal}</td>`;
                    html += `<td style="padding: 10px; font-weight: bold; color: #fff;">${record.score}</td>`;
                    html += `<td style="padding: 10px;">${record.wave}</td>`;
                    html += `<td style="padding: 10px; color: #aaa;">${record.date} ${record.time}</td>`;
                    html += `</tr>`;
                });
                
                html += '</tbody></table></div>';
                recordsList.innerHTML = html;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤:', e);
            }
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ö–æ–ª—Å—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('load', () => {
            resizeCanvas();
            requestAnimationFrame(gameLoop);
        });
        
        window.addEventListener('resize', () => {
            resizeCanvas();
        });
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ–Ω–æ–≤—ã—Ö —á–∞—Å—Ç–∏—Ü
        createBackgroundParticles();
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤
        updateRecordsDisplay();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
        updateUI();
        showMessage("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –±–∞—à–Ω—é –Ω–∞ –ø–æ–ª–µ –¥–ª—è –∑–∞—â–∏—Ç—ã.");
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    document.getElementById('pauseGameBtn').click();
                    break;
                case 'Enter':
                    if (!gameState.gameRunning || gameState.gameOver) {
                        document.getElementById('startWaveBtn').click();
                    }
                    break;
                case '1':
                case '2':
                case '3':
                case '4':
                    const index = parseInt(e.key) - 1;
                    const cards = document.querySelectorAll('.tower-card');
                    if (cards[index]) cards[index].click();
                    break;
                case 'Escape':
                    closeModal('helpModal');
                    closeModal('recordsModal');
                    closeModal('upgradeModal');
                    break;
                case 'r':
                case 'R':
                    restoreLives();
                    break;
            }
        });
        
        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        if ('ontouchstart' in window) {
            canvas.style.touchAction = 'none';
            
            // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
            document.querySelectorAll('.game-button').forEach(button => {
                button.style.padding = '15px';
                button.style.fontSize = '1.1rem';
            });
        }
    </script>
</body>
</html>
